<!doctype html>
<html>
<head>
    <title>Marketing Emails - CRM Atlantic Diving Center</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <style>
        .chat-container {
            height: 400px;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            background-color: #f8f9fa;
        }

        .chat-messages {
            height: 350px;
            overflow-y: auto;
            padding: 15px;
        }

        .chat-input {
            height: 50px;
            border-top: 1px solid #dee2e6;
            padding: 10px;
            background-color: white;
        }

        .message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 15px;
            max-width: 80%;
        }

        .message.sent {
            background-color: #007bff;
            color: white;
            margin-left: auto;
        }

        .message.received {
            background-color: #e9ecef;
            color: #212529;
        }

        .message.system {
            background-color: #ffc107;
            color: #212529;
            text-align: center;
            max-width: 100%;
        }

        .message.error {
            background-color: #dc3545;
            color: white;
            text-align: center;
            max-width: 100%;
        }

        .message.success {
            background-color: #28a745;
            color: white;
            text-align: center;
            max-width: 100%;
        }
    </style>
</head>
<body class="bg-light">

<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Marketing Emails</h2>
        <div>
            <a href="{{ url_for('marketing_email_editor') }}" class="btn btn-primary me-2">
                <i class="fas fa-table"></i> Editor de Listas
            </a>
            <a href="{{ url_for('index') }}" class="btn btn-secondary">Voltar</a>
        </div>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show"
                     role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <form method="post" id="marketingForm">
        <!-- Email Editor Section (Top) -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">üìß Composer de Email Marketing</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Assunto do Email:</label>
                            <input type="text" name="subject" class="form-control" required
                                   placeholder="Ex: Novidades da Atlantic Diving Center">
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Conte√∫do do Email:</label>
                    <div id="emailEditor" style="height: 300px;"></div>
                    <input type="hidden" name="content" id="emailContent">
                    <input type="hidden" name="include_database" id="includeDatabaseHidden">
                </div>

                <button type="submit" class="btn btn-primary btn-lg" onclick="sendMarketingEmail()">
                    üì§ Enviar Marketing Email
                </button>
            </div>
        </div>


        <!-- Bulk Email Input Section (Bottom) -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">üìß Lista de Emails para Marketing</h5>
            </div>
            <div class="card-body">


                <!-- Excel Upload Section -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card border-info">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0">üìä Importar Excel </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Selecionar arquivo Excel:</label>
                                            <input type="file" class="form-control" id="marketingExcelFile"
                                                   accept=".xlsx,.xls">
                                            <small class="text-muted">Formatos aceitos: .xlsx, .xls</small>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Nome da lista:</label>
                                            <input type="text" class="form-control" id="listName"
                                                   placeholder="Ex: Lista de Marketing" value="Lista de Marketing">
                                            <small class="text-muted">Nome para identificar esta lista de emails</small>
                                        </div>
                                        <div class="mb-3">
                                            <button type="button" class="btn btn-outline-primary btn-sm"
                                                    onclick="previewMarketingExcelColumns()">
                                                üîç Pr√©-visualizar Colunas
                                            </button>
                                            <button type="button" class="btn btn-outline-success btn-sm"
                                                    onclick="uploadMarketingExcelEmails()" id="uploadMarketingBtn"
                                                    disabled>
                                                üì• Carregar
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Coluna com emails:</label>
                                            <select class="form-control" id="marketingEmailColumnSelect" disabled>
                                                <option value="">Selecione uma coluna...</option>
                                            </select>
                                            <small class="text-muted">Escolha a coluna que cont√©m os endere√ßos de
                                                email</small>
                                        </div>
                                        <div id="marketingColumnPreview" class="alert alert-info"
                                             style="display: none;">
                                            <small>
                                                <strong>üìã Pr√©-visualiza√ß√£o:</strong><br>
                                                <span id="marketingColumnInfo"></span>
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Existing Email Lists Section -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card border-warning">
                                <div class="card-header bg-warning text-dark">
                                    <h6 class="mb-0">üìã Listas Existentes</h6>
                                </div>
                                <div class="card-body">
                                    <div id="existingListsContainer">
                                        {% if email_lists %}
                                            {% for list in email_lists %}
                                                <div class="list-item mb-3 p-3 border rounded">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <div>
                                                            <h6 class="mb-1">{{ list.list_name }}</h6>
                                                            <small class="text-muted">{{ list.email_count }}
                                                                emails</small>
                                                        </div>
                                                        <div>
                                                            <button type="button" class="btn btn-outline-primary btn-sm"
                                                                    onclick="loadEmailList('{{ list.list_name }}')">
                                                                üì• Carregar
                                                            </button>
                                                            <button type="button" class="btn btn-outline-danger btn-sm"
                                                                    onclick="deleteEmailList('{{ list.list_name }}')">
                                                                üóëÔ∏è Remover
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            {% endfor %}
                                        {% else %}
                                            <div class="text-center text-muted">
                                                <p>Nenhuma lista de emails encontrada.</p>
                                                <small>Fa√ßa upload de um arquivo Excel para criar sua primeira
                                                    lista.</small>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label class="form-label">Emails (um por linha ou separados por v√≠rgula):</label>
                                <textarea class="form-control" id="bulkEmails" name="bulk_emails" rows="8"
                                          placeholder="Cole aqui os emails para marketing...
Exemplo:
joao@email.com
maria@email.com
pedro@email.com

Ou separados por v√≠rgula:
joao@email.com, maria@email.com, pedro@email.com"></textarea>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Op√ß√µes:</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="includeDatabase" checked>
                                    <label class="form-check-label" for="includeDatabase">
                                        Incluir clientes da base de dados
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="validateEmails" checked>
                                    <label class="form-check-label" for="validateEmails">
                                        Validar formato dos emails
                                    </label>
                                </div>
                            </div>
                            <div class="mb-3">
                                <button type="button" class="btn btn-outline-secondary btn-sm"
                                        onclick="validateEmailList()">
                                    üîç Validar Emails
                                </button>
                                <button type="button" class="btn btn-outline-info btn-sm" onclick="clearEmailList()">
                                    üóëÔ∏è Limpar Lista
                                </button>
                            </div>
                            <div id="emailStats" class="alert alert-info" style="display: none;">
                                <small>
                                    <strong>üìä Estat√≠sticas:</strong><br>
                                    <span id="validEmails">0</span> emails v√°lidos<br>
                                    <span id="invalidEmails">0</span> emails inv√°lidos
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
    </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // Initialize Quill editor
    var quill = new Quill('#emailEditor', {
        theme: 'snow',
        modules: {
            toolbar: [
                ['bold', 'italic', 'underline'],
                [{'list': 'ordered'}, {'list': 'bullet'}],
                ['link', 'image'],
                ['clean']
            ]
        },
        placeholder: 'Escreva o conte√∫do do seu email marketing aqui...'
    });

    // Email validation function
    function isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email.trim());
    }

    // Parse emails from textarea
    function parseEmails(emailText) {
        if (!emailText.trim()) return [];

        const emails = [];
        const lines = emailText.trim().split('\n');

        for (let line of lines) {
            if (line.trim()) {
                // Split by commas if present
                if (line.includes(',')) {
                    const emailsInLine = line.split(',').map(email => email.trim()).filter(email => email.length > 0);
                    emails.push(...emailsInLine);
                } else {
                    emails.push(line.trim());
                }
            }
        }

        return emails;
    }

    // Validate email list
    function validateEmailList() {
        const emailText = document.getElementById('bulkEmails').value;
        const emails = parseEmails(emailText);

        let validCount = 0;
        let invalidCount = 0;
        const validEmails = [];
        const invalidEmails = [];

        emails.forEach(email => {
            if (isValidEmail(email)) {
                validCount++;
                validEmails.push(email);
            } else {
                invalidCount++;
                invalidEmails.push(email);
            }
        });

        // Update statistics
        document.getElementById('validEmails').textContent = validCount;
        document.getElementById('invalidEmails').textContent = invalidCount;
        document.getElementById('emailStats').style.display = 'block';

        // Show results
        let message = `<strong>üîç Valida√ß√£o de Emails:</strong><br>`;
        message += `‚úÖ ${validCount} emails v√°lidos<br>`;
        if (invalidCount > 0) {
            message += `‚ùå ${invalidCount} emails inv√°lidos: ${invalidEmails.join(', ')}`;
        }

        alert(message);
    }

    // Clear email list
    function clearEmailList() {
        if (confirm('Tem certeza que deseja limpar a lista de emails? Esta a√ß√£o ir√° remover permanentemente todos os emails salvos.')) {
            // Create a form to submit the clear request
            var form = document.createElement('form');
            form.method = 'POST';
            form.action = '{{ url_for("clear_marketing_emails") }}';

            document.body.appendChild(form);
            form.submit();
        }
    }

    // Send marketing email function
    function sendMarketingEmail() {
        const subject = document.querySelector('input[name="subject"]').value;
        const content = quill.root.innerHTML;
        const includeDatabase = document.getElementById('includeDatabase').checked;
        const validateEmails = document.getElementById('validateEmails').checked;

        if (!subject.trim()) {
            alert('‚ùå Erro: Por favor, preencha o assunto do email.');
            return false;
        }

        if (!content.trim() || content === '<p><br></p>') {
            alert('‚ùå Erro: Por favor, preencha o conte√∫do do email.');
            return false;
        }

        // Get bulk emails
        const emailText = document.getElementById('bulkEmails').value;
        const bulkEmails = parseEmails(emailText);

        // Validate emails if option is checked
        if (validateEmails && bulkEmails.length > 0) {
            const invalidEmails = bulkEmails.filter(email => !isValidEmail(email));
            if (invalidEmails.length > 0) {
                alert(`‚ùå Erro: Emails inv√°lidos encontrados: ${invalidEmails.join(', ')}`);
                return false;
            }
        }

        // Check if we have any recipients
        if (!includeDatabase && bulkEmails.length === 0) {
            alert('‚ùå Erro: Nenhum destinat√°rio selecionado. Adicione emails ou marque "Incluir clientes da base de dados".');
            return false;
        }

        // Update hidden inputs
        document.getElementById('emailContent').value = content;
        document.getElementById('includeDatabaseHidden').value = includeDatabase ? 'on' : 'off';

        // Show confirmation
        const databaseCount = parseInt('{{ client_count }}');
        const totalRecipients = includeDatabase ? (databaseCount + bulkEmails.length) : bulkEmails.length;
        const confirmMessage = `üì§ Confirmar envio de marketing email para ${totalRecipients} destinat√°rios?`;

        if (confirm(confirmMessage)) {
            return true;
        } else {
            return false;
        }
    }

    // Handle form submission
    document.getElementById('marketingForm').addEventListener('submit', function (e) {
        if (!sendMarketingEmail()) {
            e.preventDefault();
        }
    });

    // Auto-validate emails when typing
    document.getElementById('bulkEmails').addEventListener('input', function () {
        const emailText = this.value;
        if (emailText.trim()) {
            const emails = parseEmails(emailText);
            const validCount = emails.filter(email => isValidEmail(email)).length;
            const invalidCount = emails.length - validCount;

            if (emails.length > 0) {
                document.getElementById('validEmails').textContent = validCount;
                document.getElementById('invalidEmails').textContent = invalidCount;
                document.getElementById('emailStats').style.display = 'block';
            } else {
                document.getElementById('emailStats').style.display = 'none';
            }
        } else {
            document.getElementById('emailStats').style.display = 'none';
        }
    });


    // Marketing email lists handling functions
    let currentMarketingExcelFile = null;
    let currentMarketingColumns = null;

    // Preview marketing Excel columns
    function previewMarketingExcelColumns() {
        const fileInput = document.getElementById('marketingExcelFile');
        if (!fileInput) {
            console.error('marketingExcelFile element not found');
            return;
        }

        const file = fileInput.files[0];

        if (!file) {
            alert('‚ùå Por favor, selecione um arquivo Excel primeiro.');
            return;
        }

        if (!file.name.match(/\.(xlsx|xls)$/)) {
            alert('‚ùå Por favor, selecione um arquivo Excel v√°lido (.xlsx ou .xls).');
            return;
        }

        const formData = new FormData();
        formData.append('excel_file', file);

        fetch('{{ url_for("preview_excel_columns") }}', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(`‚ùå Erro: ${data.error}`);
                    return;
                }

                currentMarketingExcelFile = file;
                currentMarketingColumns = data.columns;

                // Populate column select
                const columnSelect = document.getElementById('marketingEmailColumnSelect');
                if (columnSelect) {
                    columnSelect.innerHTML = '<option value="">Selecione uma coluna...</option>';

                    data.columns.forEach(column => {
                        const option = document.createElement('option');
                        option.value = column.name;
                        option.textContent = `${column.name} (${column.non_null_count} valores)`;
                        columnSelect.appendChild(option);
                    });

                    columnSelect.disabled = false;
                }

                const uploadBtn = document.getElementById('uploadMarketingBtn');
                if (uploadBtn) {
                    uploadBtn.disabled = false;
                }

                // Show preview
                if (data.columns.length > 0) {
                    showMarketingColumnPreview(data.columns[0]);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('‚ùå Erro ao processar arquivo Excel.');
            });
    }

    // Show marketing column preview
    function showMarketingColumnPreview(column) {
        const previewDiv = document.getElementById('marketingColumnPreview');
        const infoSpan = document.getElementById('marketingColumnInfo');

        if (column) {
            const sampleText = column.sample_values.slice(0, 3).join(', ');
            infoSpan.innerHTML = `
                <strong>${column.name}</strong><br>
                ${column.non_null_count} valores n√£o vazios<br>
                Amostra: ${sampleText}${column.sample_values.length > 3 ? '...' : ''}
            `;
            previewDiv.style.display = 'block';
        } else {
            previewDiv.style.display = 'none';
        }
    }

    // Upload marketing Excel emails to Supabase
    function uploadMarketingExcelEmails() {
        const fileInput = document.getElementById('marketingExcelFile');
        const columnSelect = document.getElementById('marketingEmailColumnSelect');
        const listNameInput = document.getElementById('listName');
        const file = fileInput.files[0];
        const selectedColumn = columnSelect.value;
        const listName = listNameInput.value.trim();

        if (!file) {
            alert('‚ùå Por favor, selecione um arquivo Excel primeiro.');
            return;
        }

        if (!selectedColumn) {
            alert('‚ùå Por favor, selecione uma coluna que cont√©m os emails.');
            return;
        }

        if (!listName) {
            alert('‚ùå Por favor, insira um nome para a lista.');
            return;
        }

        const formData = new FormData();
        formData.append('excel_file', file);
        formData.append('email_column', selectedColumn);
        formData.append('list_name', listName);

        // Show loading state
        const uploadBtn = document.getElementById('uploadMarketingBtn');
        const originalText = uploadBtn.innerHTML;
        uploadBtn.innerHTML = '‚è≥ Processando...';
        uploadBtn.disabled = true;

        fetch('{{ url_for("upload_marketing_emails_excel") }}', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(`‚ùå Erro: ${data.error}`);
                    return;
                }

                // Show success message
                alert(`‚úÖ ${data.message}`);

                // Auto-load the updated list into the textarea
                if (data.success) {
                    const bulkEmailsTextarea = document.getElementById('bulkEmails');
                    const listName = document.getElementById('listName').value.trim();

                    // Fetch the updated list and load it
                    fetch('{{ url_for("get_marketing_email_lists") }}')
                        .then(response => response.json())
                        .then(listsData => {
                            if (!listsData.error) {
                                const updatedList = listsData.lists.find(l => l.list_name === listName);
                                if (updatedList) {
                                    bulkEmailsTextarea.value = updatedList.emails.join('\n');
                                    alert(`‚úÖ Lista "${listName}" atualizada e carregada automaticamente com ${updatedList.email_count} emails!`);

                                    // Update the existing lists display without page reload
                                    updateExistingListsDisplay(listsData.lists);
                                }
                            }
                        })
                        .catch(error => {
                            console.error('Error loading updated list:', error);
                        });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('‚ùå Erro ao carregar emails para Supabase.');
            })
            .finally(() => {
                // Reset button state
                uploadBtn.innerHTML = originalText;
                uploadBtn.disabled = false;
            });
    }

    // Load email list to textarea
    function loadEmailList(listName) {
        fetch('{{ url_for("get_marketing_email_lists") }}')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(`‚ùå Erro: ${data.error}`);
                    return;
                }

                const list = data.lists.find(l => l.list_name === listName);
                if (list) {
                    const bulkEmailsTextarea = document.getElementById('bulkEmails');
                    bulkEmailsTextarea.value = list.emails.join('\n');
                    alert(`‚úÖ Lista "${listName}" carregada com ${list.email_count} emails!`);
                } else {
                    alert(`‚ùå Lista "${listName}" n√£o encontrada.`);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('‚ùå Erro ao carregar lista de emails.');
            });
    }

    // Delete email list
    function deleteEmailList(listName) {
        if (!confirm(`Tem certeza que deseja remover a lista "${listName}"? Esta a√ß√£o n√£o pode ser desfeita.`)) {
            return;
        }

        const formData = new FormData();
        formData.append('list_name', listName);

        fetch('{{ url_for("delete_marketing_email_list") }}', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(`‚ùå Erro: ${data.error}`);
                    return;
                }

                alert(`‚úÖ ${data.message}`);

                // Refresh the lists display without page reload
                fetch('{{ url_for("get_marketing_email_lists") }}')
                    .then(response => response.json())
                    .then(listsData => {
                        if (!listsData.error) {
                            updateExistingListsDisplay(listsData.lists);
                        }
                    })
                    .catch(error => {
                        console.error('Error refreshing lists:', error);
                    });
            })
            .catch(error => {
                console.error('Error:', error);
                alert('‚ùå Erro ao remover lista de emails.');
            });
    }


    // Handle marketing Excel file input change
    const marketingExcelFileInput = document.getElementById('marketingExcelFile');
    if (marketingExcelFileInput) {
        marketingExcelFileInput.addEventListener('change', function () {
            const file = this.files[0];
            if (file) {
                // Reset form when new file is selected
                const columnSelect = document.getElementById('marketingEmailColumnSelect');
                if (columnSelect) {
                    columnSelect.innerHTML = '<option value="">Selecione uma coluna...</option>';
                    columnSelect.disabled = true;
                }

                const uploadBtn = document.getElementById('uploadMarketingBtn');
                if (uploadBtn) {
                    uploadBtn.disabled = true;
                }

                const previewDiv = document.getElementById('marketingColumnPreview');
                if (previewDiv) {
                    previewDiv.style.display = 'none';
                }

                currentMarketingExcelFile = null;
                currentMarketingColumns = null;
            }
        });
    }

    // Handle marketing column selection change
    const marketingColumnSelect = document.getElementById('marketingEmailColumnSelect');
    if (marketingColumnSelect) {
        marketingColumnSelect.addEventListener('change', function () {
            const selectedColumn = this.value;
            if (selectedColumn && currentMarketingColumns) {
                const column = currentMarketingColumns.find(col => col.name === selectedColumn);
                showMarketingColumnPreview(column);
            } else {
                const previewDiv = document.getElementById('marketingColumnPreview');
                if (previewDiv) {
                    previewDiv.style.display = 'none';
                }
            }
        });
    }

    // Update existing lists display without page reload
    function updateExistingListsDisplay(lists) {
        const container = document.getElementById('existingListsContainer');

        if (lists.length === 0) {
            container.innerHTML = `
                <div class="text-center text-muted">
                    <p>Nenhuma lista de emails encontrada.</p>
                    <small>Fa√ßa upload de um arquivo Excel para criar sua primeira lista.</small>
                </div>
            `;
            return;
        }

        let html = '';
        lists.forEach(list => {
            html += `
                <div class="list-item mb-3 p-3 border rounded">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">${list.list_name}</h6>
                            <small class="text-muted">${list.email_count} emails</small>
                        </div>
                        <div>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="loadEmailList('${list.list_name}')">
                                üì• Carregar
                            </button>
                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="deleteEmailList('${list.list_name}')">
                                üóëÔ∏è Remover
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });

        container.innerHTML = html;
    }
</script>

</body>
</html> 