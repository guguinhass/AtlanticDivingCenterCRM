<!doctype html>
<html>
<head>
    <title>Marketing Emails - CRM Atlantic Diving Center</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <style>
        .chat-container {
            height: 400px;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            background-color: #f8f9fa;
        }

        .chat-messages {
            height: 350px;
            overflow-y: auto;
            padding: 15px;
        }

        .chat-input {
            height: 50px;
            border-top: 1px solid #dee2e6;
            padding: 10px;
            background-color: white;
        }

        .message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 15px;
            max-width: 80%;
        }

        .message.sent {
            background-color: #007bff;
            color: white;
            margin-left: auto;
        }

        .message.received {
            background-color: #e9ecef;
            color: #212529;
        }

        .message.system {
            background-color: #ffc107;
            color: #212529;
            text-align: center;
            max-width: 100%;
        }

        .message.error {
            background-color: #dc3545;
            color: white;
            text-align: center;
            max-width: 100%;
        }

        .message.success {
            background-color: #28a745;
            color: white;
            text-align: center;
            max-width: 100%;
        }

        .duplicate-warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 0.375rem;
            padding: 10px;
            margin: 10px 0;
        }

        .upload-progress {
            display: none;
            margin-top: 10px;
        }

        /* Email Search Styles */
        #emailSearchBox {
            border-radius: 0.375rem 0 0 0.375rem;
            transition: all 0.2s ease;
        }

        #emailSearchBox:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
            background-color: #fff;
        }

        #emailSearchBox.has-results {
            border-color: #28a745;
            background-color: #f8fff9;
        }

        #emailSearchBox.no-results {
            border-color: #dc3545;
            background-color: #fff5f5;
        }

        .input-group .btn:last-child {
            border-radius: 0 0.375rem 0.375rem 0;
        }

        #searchResults {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 8px 12px;
            font-size: 0.875rem;
            animation: slideDown 0.2s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        #searchResults .btn-group {
            margin-left: 10px;
        }

        #bulkEmails:focus {
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        /* Highlight selected text in textarea */
        #bulkEmails::selection {
            background-color: #007bff;
            color: white;
        }

        /* Search box placeholder animation */
        #emailSearchBox::placeholder {
            transition: opacity 0.2s ease;
        }

        #emailSearchBox:focus::placeholder {
            opacity: 0.5;
        }
    </style>
</head>
<body class="bg-light">

<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="d-flex align-items-center gap-3">
            <h2 class="mb-0">Marketing Emails</h2>
            <span class="text-muted">Ol√°, {{ session.get('username', 'Utilizador') }}</span>
        </div>
        <div class="d-flex gap-2">
            <a href="{{ url_for('marketing_email_editor') }}" class="btn btn-primary">
                <i class="fas fa-table"></i> Editor de Listas
            </a>
            <a href="{{ url_for('index') }}" class="btn btn-secondary">Voltar</a>
            <a href="{{ url_for('logout') }}" class="btn btn-outline-danger">
                <i class="fas fa-sign-out-alt"></i> Logout
            </a>
        </div>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show"
                     role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <form method="post" id="marketingForm">
        <!-- Email Editor Section (Top) -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">üìß Composer de Email Marketing</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Assunto do Email:</label>
                            <input type="text" name="subject" class="form-control" required
                                   placeholder="Ex: Novidades da Atlantic Diving Center">
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Conte√∫do do Email:</label>
                    <div class="mb-2">
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="attachImage()">
                            <i class="fas fa-image"></i> Anexar Imagem
                        </button>
                        <input type="file" id="imageInput" accept="image/*" style="display: none;"
                               onchange="handleImageUpload(this)">
                        <small class="text-muted d-block mt-1">
                            <i class="fas fa-info-circle"></i> As imagens ser√£o enviadas como anexos separados no email.
                        </small>
                    </div>
                    <div id="attachmentList" class="mb-2" style="display: none;">
                        <div class="card">
                            <div class="card-header py-2">
                                <h6 class="mb-0"><i class="fas fa-paperclip"></i> Anexos</h6>
                            </div>
                            <div class="card-body py-2" id="attachmentItems">
                                <!-- Attachment items will be added here -->
                            </div>
                        </div>
                    </div>
                    <div id="emailEditor" style="height: 300px;"></div>
                    <input type="hidden" name="content" id="emailContent">
                    <input type="hidden" name="include_database" id="includeDatabaseHidden">
                </div>

                <button type="submit" class="btn btn-primary btn-lg" onclick="sendMarketingEmail()">
                    üì§ Enviar Marketing Email
                </button>
            </div>
        </div>


        <!-- Bulk Email Input Section (Bottom) -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">üìß Lista de Emails para Marketing</h5>
            </div>
            <div class="card-body">


                <!-- Excel Upload Section -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card border-info">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0">üìä Importar Excel </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Selecionar arquivo Excel:</label>
                                            <input type="file" class="form-control" id="marketingExcelFile"
                                                   accept=".xlsx,.xls">
                                            <small class="text-muted">Formatos aceitos: .xlsx, .xls</small>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Nome da lista:</label>
                                            <input type="text" class="form-control" id="listName"
                                                   placeholder="Ex: Lista de Marketing" value="Lista de Marketing">
                                            <small class="text-muted">Nome para identificar esta lista de emails</small>
                                        </div>
                                        <div class="mb-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="replaceExistingList"
                                                       >
                                                <label class="form-check-label" for="replaceExistingList">
                                                    Substituir lista existente (se j√° existir)
                                                </label>
                                                <small class="text-muted d-block">Se desmarcado, emails ser√£o
                                                    adicionados √† lista existente</small>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <button type="button" class="btn btn-outline-info btn-sm"
                                                    onclick="previewMarketingExcelSheets()">
                                                üìã Ver Planilhas
                                            </button>
                                            <button type="button" class="btn btn-outline-primary btn-sm"
                                                    onclick="previewMarketingExcelColumns()" id="previewColumnsBtn"
                                                    disabled>
                                                üîç Pr√©-visualizar Colunas
                                            </button>
                                            <button type="button" class="btn btn-outline-success btn-sm"
                                                    onclick="uploadMarketingExcelEmails()" id="uploadMarketingBtn"
                                                    disabled>
                                                üì• Carregar
                                            </button>
                                        </div>
                                        <div id="uploadProgress" class="upload-progress">
                                            <div class="progress">
                                                <div class="progress-bar progress-bar-striped progress-bar-animated"
                                                     role="progressbar" style="width: 100%">
                                                    Processando...
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Planilha:</label>
                                            <select class="form-control" id="marketingSheetSelect" disabled>
                                                <option value="">Selecione uma planilha...</option>
                                            </select>
                                            <small class="text-muted">Escolha a planilha que cont√©m os dados</small>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Coluna com emails:</label>
                                            <select class="form-control" id="marketingEmailColumnSelect" disabled>
                                                <option value="">Selecione uma coluna...</option>
                                            </select>
                                            <small class="text-muted">Escolha a coluna que cont√©m os endere√ßos de
                                                email</small>
                                        </div>
                                        <div id="marketingColumnPreview" class="alert alert-info"
                                             style="display: none;">
                                            <small>
                                                <strong>üìã Pr√©-visualiza√ß√£o:</strong><br>
                                                <span id="marketingColumnInfo"></span>
                                            </small>
                                        </div>
                                        <div id="duplicateWarning" class="duplicate-warning" style="display: none;">
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                                                <div>
                                                    <strong>Aten√ß√£o:</strong> Esta lista j√° existe!
                                                    <div id="duplicateDetails" class="small mt-1"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Existing Email Lists Section -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card border-warning">
                                <div class="card-header bg-warning text-dark">
                                    <h6 class="mb-0">üìã Listas Existentes</h6>
                                </div>
                                <div class="card-body">
                                    <div id="existingListsContainer">
                                        {% if email_lists %}
                                            {% for list in email_lists %}
                                                <div class="list-item mb-3 p-3 border rounded">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <div>
                                                            <h6 class="mb-1">{{ list.list_name }}</h6>
                                                            <small class="text-muted">{{ list.email_count }}
                                                                emails</small>
                                                        </div>
                                                        <div>
                                                            <button type="button" class="btn btn-outline-primary btn-sm"
                                                                    onclick="loadEmailList('{{ list.list_name }}')">
                                                                üì• Carregar
                                                            </button>
                                                            <button type="button" class="btn btn-outline-danger btn-sm"
                                                                    onclick="deleteEmailList('{{ list.list_name }}')">
                                                                üóëÔ∏è Remover
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            {% endfor %}
                                        {% else %}
                                            <div class="text-center text-muted">
                                                <p>Nenhuma lista de emails encontrada.</p>
                                                <small>Fa√ßa upload de um arquivo Excel para criar sua primeira
                                                    lista.</small>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label class="form-label">Emails (um por linha):</label>
                                <!-- Email Search Box -->
                                <div class="input-group mb-2">
                                    <span class="input-group-text">
                                        <i class="fas fa-search"></i>
                                    </span>
                                    <input type="text" class="form-control" id="emailSearchBox" 
                                           placeholder="Pesquisar email na lista..." 
                                           title="Digite para pesquisar emails. Use Enter/Shift+Enter para navegar, Escape para limpar, Ctrl+F para focar aqui"
                                           oninput="searchEmailInTextarea()" 
                                           onkeydown="handleSearchNavigation(event)">
                                    <button class="btn btn-outline-secondary" type="button" onclick="clearEmailSearch()">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <div id="searchResults" class="small text-muted mb-2" style="display: none;">
                                    <span id="searchResultText"></span>
                                    <div class="btn-group btn-group-sm ms-2" role="group">
                                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="navigateSearchResults('prev')">
                                            <i class="fas fa-chevron-up"></i> Anterior
                                        </button>
                                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="navigateSearchResults('next')">
                                            <i class="fas fa-chevron-down"></i> Pr√≥ximo
                                        </button>
                                    </div>
                                </div>
                                <textarea class="form-control" id="bulkEmails" name="bulk_emails" rows="8"
                                          placeholder="Cole aqui os emails para marketing...
Exemplo:
joao@email.com
maria@email.com
pedro@email.com

Ou separados por v√≠rgula:
joao@email.com, maria@email.com, pedro@email.com

üí° Dica: Use a caixa de pesquisa acima para encontrar emails espec√≠ficos!"></textarea>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Op√ß√µes:</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="includeDatabase" >
                                    <label class="form-check-label" for="includeDatabase">
                                        Incluir clientes da base de dados
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="validateEmails">
                                    <label class="form-check-label" for="validateEmails">
                                        Validar formato dos emails
                                    </label>
                                </div>
                            </div>
                            <div class="mb-3">
                                <button type="button" class="btn btn-outline-secondary btn-sm"
                                        onclick="validateEmailList()">
                                    üîç Validar Emails
                                </button>
                                <button type="button" class="btn btn-outline-info btn-sm" onclick="clearEmailList()">
                                    üóëÔ∏è Limpar Lista
                                </button>
                                <button type="button" class="btn btn-outline-warning btn-sm" onclick="addTestEmails()">
                                    üß™ Emails de Teste
                                </button>
                                <button type="button" class="btn btn-outline-info btn-sm" onclick="debugUploadParams()">
                                    üîç Debug Upload
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="debugExcelContent()">
                                    üìä Debug Excel
                                </button>
                                <a href="{{ url_for('generate_test_excel') }}" class="btn btn-outline-success btn-sm">
                                    üì• Download Test Excel
                                </a>
                            </div>
                            <div id="emailStats" class="alert alert-info" style="display: none;">
                                <small>
                                    <strong>üìä Estat√≠sticas:</strong><br>
                                    <span id="validEmails">0</span> emails v√°lidos<br>
                                    <span id="invalidEmails">0</span> emails inv√°lidos
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
    </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // Initialize Quill editor
    var quill = new Quill('#emailEditor', {
        theme: 'snow',
        modules: {
            toolbar: [
                ['bold', 'italic', 'underline'],
                [{'list': 'ordered'}, {'list': 'bullet'}],
                ['link', 'image'],
                ['clean']
            ]
        },
        placeholder: 'Escreva o conte√∫do do seu email marketing aqui...'
    });

    // Attachment handling state and helpers
    let emailAttachments = [];

    function attachImage() {
        const input = document.getElementById('imageInput');
        if (input) input.click();
    }

    function handleImageUpload(input) {
        const file = input && input.files ? input.files[0] : null;
        if (!file) return;

        emailAttachments.push({ file });
        updateAttachmentUI();
        // reset input so the same file can be selected again if needed
        input.value = '';
    }

    function removeAttachment(index) {
        if (index >= 0 && index < emailAttachments.length) {
            emailAttachments.splice(index, 1);
            updateAttachmentUI();
        }
    }

    function updateAttachmentUI() {
        const listContainer = document.getElementById('attachmentItems');
        const wrapper = document.getElementById('attachmentList');
        if (!listContainer || !wrapper) return;

        listContainer.innerHTML = '';
        emailAttachments.forEach((att, idx) => {
            const row = document.createElement('div');
            row.className = 'd-flex justify-content-between align-items-center py-1';
            const sizeKb = Math.max(1, Math.round((att.file.size || 0) / 1024));
            row.innerHTML = `
                <span class="small">${att.file.name} (${sizeKb} KB)</span>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeAttachment(${idx})">Remover</button>
            `;
            listContainer.appendChild(row);
        });

        wrapper.style.display = emailAttachments.length > 0 ? 'block' : 'none';
    }

    // Email validation function
    function isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email.trim());
    }

    // Parse emails from textarea
    function parseEmails(emailText) {
        if (!emailText.trim()) return [];

        const emails = [];
        const lines = emailText.trim().split('\n');

        for (let line of lines) {
            if (line.trim()) {
                // Split by commas if present
                if (line.includes(',')) {
                    const emailsInLine = line.split(',').map(email => email.trim()).filter(email => email.length > 0);
                    emails.push(...emailsInLine);
                } else {
                    emails.push(line.trim());
                }
            }
        }

        return emails;
    }

    // Validate email list
    function validateEmailList() {
        const emailText = document.getElementById('bulkEmails').value;
        const emails = parseEmails(emailText);

        let validCount = 0;
        let invalidCount = 0;
        const validEmails = [];
        const invalidEmails = [];

        emails.forEach(email => {
            if (isValidEmail(email)) {
                validCount++;
                validEmails.push(email);
            } else {
                invalidCount++;
                invalidEmails.push(email);
            }
        });

        // Update statistics
        document.getElementById('validEmails').textContent = validCount;
        document.getElementById('invalidEmails').textContent = invalidCount;
        document.getElementById('emailStats').style.display = 'block';

        // Show results
        let message = `üîç Valida√ß√£o de Emails\n`;
        message += `‚úÖ ${validCount} emails v√°lidos\n`;
        if (invalidCount > 0) {
            message += `‚ùå ${invalidCount} emails inv√°lidos: ${invalidEmails.join(', ')}`;
        }

        alert(message);
    }

    // Clear email list
    function clearEmailList() {
        if (confirm('Tem certeza que deseja limpar a lista de emails?')) {
            // Create a form to submit the clear request
            var form = document.createElement('form');
            form.method = 'POST';
            form.action = '{{ url_for("clear_marketing_emails") }}';

            document.body.appendChild(form);
            form.submit();
        }
    }

    // Send marketing email function
    function sendMarketingEmail() {
        const subject = document.querySelector('input[name="subject"]').value;
        const content = quill.root.innerHTML;
        const includeDatabase = document.getElementById('includeDatabase').checked;
        const validateEmails = document.getElementById('validateEmails').checked;

        if (!subject.trim()) {
            alert('‚ùå Erro: Por favor, preencha o assunto do email.');
            return false;
        }

        if (!content.trim() || content === '<p><br></p>') {
            alert('‚ùå Erro: Por favor, preencha o conte√∫do do email.');
            return false;
        }

        // Get bulk emails
        const emailText = document.getElementById('bulkEmails').value;
        const bulkEmails = parseEmails(emailText);

        // Validate emails if option is checked
        if (validateEmails && bulkEmails.length > 0) {
            const invalidEmails = bulkEmails.filter(email => !isValidEmail(email));
            if (invalidEmails.length > 0) {
                alert(`‚ùå Erro: Emails inv√°lidos encontrados: ${invalidEmails.join(', ')}`);
                return false;
            }
        }

        // Check if we have any recipients
        if (!includeDatabase && bulkEmails.length === 0) {
            alert('‚ùå Erro: Nenhum destinat√°rio selecionado. Adicione emails ou marque "Incluir clientes da base de dados".');
            return false;
        }

        // Update hidden inputs
        document.getElementById('emailContent').value = content;
        document.getElementById('includeDatabaseHidden').value = includeDatabase ? 'on' : 'off';

        // Show confirmation
        const databaseCount = parseInt('{{ client_count }}');
        const totalRecipients = includeDatabase ? (databaseCount + bulkEmails.length) : bulkEmails.length;
        const attachmentText = emailAttachments.length > 0 ? ` com ${emailAttachments.length} anexo(s)` : '';
        const confirmMessage = `üì§ Confirmar envio de marketing email para ${totalRecipients} destinat√°rios${attachmentText}?`;

        if (confirm(confirmMessage)) {
            return true;
        } else {
            return false;
        }
    }

    // Handle form submission
    document.getElementById('marketingForm').addEventListener('submit', function (e) {
        e.preventDefault(); // Always prevent default to handle with AJAX

        if (!sendMarketingEmail()) {
            return;
        }

        // Create FormData from the form
        const formData = new FormData(this);

        // Add attachments to form data
        emailAttachments.forEach((attachment, index) => {
            formData.append(`attachment_${index}`, attachment.file);
        });

        // Show loading state
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = 'üì§ Enviando...';
        submitBtn.disabled = true;

        // Send the form data via AJAX
        fetch('{{ url_for("marketing_emails") }}', {
            method: 'POST',
            body: formData
        })
            .then(response => {
                if (response.redirected) {
                    window.location.href = response.url;
                } else {
                    return response.text();
                }
            })
            .then(html => {
                if (html) {
                    // Replace the page content with the response
                    document.documentElement.innerHTML = html;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('‚ùå Erro ao enviar marketing email: ' + error.message);
            })
            .finally(() => {
                // Restore button state
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            });
    });

    // Auto-validate emails when typing
    document.getElementById('bulkEmails').addEventListener('input', function () {
        const emailText = this.value;
        if (emailText.trim()) {
            const emails = parseEmails(emailText);
            const validCount = emails.filter(email => isValidEmail(email)).length;
            const invalidCount = emails.length - validCount;

            if (emails.length > 0) {
                document.getElementById('validEmails').textContent = validCount;
                document.getElementById('invalidEmails').textContent = invalidCount;
                document.getElementById('emailStats').style.display = 'block';
            } else {
                document.getElementById('emailStats').style.display = 'none';
            }
        } else {
            document.getElementById('emailStats').style.display = 'none';
        }
    });


    // Marketing email lists handling functions
    let currentMarketingExcelFile = null;
    let currentMarketingColumns = null;
    let currentMarketingSheets = null;
    let selectedSheet = null;
    let existingEmailLists = [];

    // Load existing lists data
    function loadExistingEmailLists() {
        fetch('{{ url_for("get_marketing_email_lists") }}')
            .then(response => response.json())
            .then(data => {
                if (!data.error) {
                    existingEmailLists = data.lists;
                }
            })
            .catch(error => {
                console.error('Error loading existing lists:', error);
            });
    }

    // Load emails from a specific list into the textarea
    function loadEmailList(listName) {
        fetch(`{{ url_for("get_marketing_list_api", list_name="") }}${listName}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(`‚ùå Erro: ${data.error}`);
                    return;
                }
                
                // Get the textarea and current content
                const textarea = document.getElementById('bulkEmails');
                const currentContent = textarea.value.trim();
                
                if (data.emails && data.emails.length > 0) {
                    // Support both array of strings and array of objects { email, name, phone }
                    let newEmails = data.emails.map(e => typeof e === 'string' ? e : (e.email || '')).filter(Boolean);
                    
                    // If there's existing content, merge the lists
                    if (currentContent) {
                        // Split existing content into emails
                        const existingEmails = currentContent.split('\n').filter(email => email.trim());
                        
                        // Combine existing and new emails, removing duplicates
                        const allEmails = [...new Set([...existingEmails, ...newEmails])];
                        
                        // Update textarea with merged list
                        textarea.value = allEmails.join('\n');
                        
                        // Show success message with merge info
                        const addedCount = newEmails.length;
                        const totalCount = allEmails.length;
                        const duplicateCount = existingEmails.length + newEmails.length - allEmails.length;
                        
                        let message = `‚úÖ Lista "${listName}" adicionada com ${addedCount} emails!\n\n`;
                        message += `üìä Total na caixa de texto: ${totalCount} emails`;
                        if (duplicateCount > 0) {
                            message += `\nüîÑ ${duplicateCount} duplicados removidos automaticamente`;
                        }
                        
                        alert(message);
                    } else {
                        // No existing content, just load the new list
                        textarea.value = newEmails.join('\n');
                        alert(`‚úÖ Lista "${listName}" carregada com ${data.email_count} emails!`);
                    }
                    
                    // Update the list name input if it exists
                    const listNameInput = document.getElementById('listName');
                    if (listNameInput) {
                        listNameInput.value = listName;
                    }
                    
                    // Update email stats with all emails in textarea
                    const allEmails = textarea.value.split('\n').filter(email => email.trim());
                    const validCount = allEmails.filter(email => isValidEmail(email)).length;
                    const invalidCount = allEmails.length - validCount;
                    
                    document.getElementById('validEmails').textContent = validCount;
                    document.getElementById('invalidEmails').textContent = invalidCount;
                    document.getElementById('emailStats').style.display = 'block';
                    
                    // Clear any existing search when loading new list
                    clearEmailSearch();
                } else {
                    alert(`‚ö†Ô∏è A lista "${listName}" n√£o cont√©m emails.`);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('‚ùå Erro ao carregar lista de emails.');
            });
    }

    // Check for duplicate list name and show warning
    function checkForDuplicateList(listName) {
        const duplicateWarning = document.getElementById('duplicateWarning');
        const duplicateDetails = document.getElementById('duplicateDetails');

        const existingList = existingEmailLists.find(list => list.list_name === listName);

        if (existingList) {
            duplicateDetails.textContent = `A lista "${listName}" j√° existe com ${existingList.email_count} emails.`;
            duplicateWarning.style.display = 'block';
        } else {
            duplicateWarning.style.display = 'none';
        }
    }

    // Preview marketing Excel sheets
    function previewMarketingExcelSheets() {
        const fileInput = document.getElementById('marketingExcelFile');
        const file = fileInput.files[0];

        if (!file) {
            alert('‚ùå Por favor, selecione um arquivo Excel primeiro.');
            return;
        }

        if (!file.name.match(/\.(xlsx|xls)$/)) {
            alert('‚ùå Por favor, selecione um arquivo Excel v√°lido (.xlsx ou .xls).');
            return;
        }

        const formData = new FormData();
        formData.append('excel_file', file);

        fetch('{{ url_for("preview_excel_sheets") }}', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(`‚ùå Erro: ${data.error}`);
                    return;
                }

                currentMarketingExcelFile = file;
                currentMarketingSheets = data.sheets;

                // Populate sheet select
                const sheetSelect = document.getElementById('marketingSheetSelect');
                if (sheetSelect) {
                    sheetSelect.innerHTML = '<option value="">Selecione uma planilha...</option>';

                    data.sheets.forEach(sheet => {
                        const option = document.createElement('option');
                        option.value = sheet.name;
                        option.textContent = `${sheet.name} (${sheet.row_count} linhas, ${sheet.columns.length} colunas)`;
                        if (sheet.error) {
                            option.textContent += ' - ERRO';
                            option.disabled = true;
                        }
                        sheetSelect.appendChild(option);
                    });

                    sheetSelect.disabled = false;
                    
                    // Enable the preview columns button
                    const previewColumnsBtn = document.getElementById('previewColumnsBtn');
                    if (previewColumnsBtn) {
                        previewColumnsBtn.disabled = false;
                    }
                }

                // Auto-select first sheet if only one exists
                if (data.sheets.length === 1 && !data.sheets[0].error) {
                    sheetSelect.value = data.sheets[0].name;
                    selectedSheet = data.sheets[0].name;
                    // Automatically preview columns for single sheet
                    previewMarketingExcelColumns();
                }

                alert(`‚úÖ Arquivo processado! Encontradas ${data.sheets.length} planilha(s).`);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('‚ùå Erro ao processar arquivo Excel.');
            });
    }

    // Handle sheet selection change
    document.addEventListener('DOMContentLoaded', function() {
        const sheetSelect = document.getElementById('marketingSheetSelect');
        if (sheetSelect) {
            sheetSelect.addEventListener('change', function() {
                selectedSheet = this.value;
                
                // Reset column selection when sheet changes
                const columnSelect = document.getElementById('marketingEmailColumnSelect');
                if (columnSelect) {
                    columnSelect.innerHTML = '<option value="">Selecione uma coluna...</option>';
                    columnSelect.disabled = true;
                }
                
                // Reset upload button
                const uploadBtn = document.getElementById('uploadMarketingBtn');
                if (uploadBtn) {
                    uploadBtn.disabled = true;
                }
                
                // Hide preview
                const previewDiv = document.getElementById('marketingColumnPreview');
                if (previewDiv) {
                    previewDiv.style.display = 'none';
                }
                
                if (selectedSheet) {
                    // Auto-preview columns when sheet is selected
                    previewMarketingExcelColumns();
                }
            });
        }
    });

    // Preview marketing Excel columns
    function previewMarketingExcelColumns() {
        const fileInput = document.getElementById('marketingExcelFile');
        if (!fileInput) {
            console.error('marketingExcelFile element not found');
            return;
        }

        const file = fileInput.files[0];

        if (!file) {
            alert('‚ùå Por favor, selecione um arquivo Excel primeiro.');
            return;
        }

        if (!file.name.match(/\.(xlsx|xls)$/)) {
            alert('‚ùå Por favor, selecione um arquivo Excel v√°lido (.xlsx ou .xls).');
            return;
        }

        // Check if a sheet is selected
        const sheetSelect = document.getElementById('marketingSheetSelect');
        const selectedSheetName = sheetSelect ? sheetSelect.value : null;
        
        if (!selectedSheetName) {
            alert('‚ùå Por favor, selecione uma planilha primeiro.');
            return;
        }

        const formData = new FormData();
        formData.append('excel_file', file);
        formData.append('sheet_name', selectedSheetName);

        fetch('{{ url_for("preview_excel_columns") }}', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(`‚ùå Erro: ${data.error}`);
                    return;
                }

                currentMarketingExcelFile = file;
                currentMarketingColumns = data.columns;

                // Populate column select
                const columnSelect = document.getElementById('marketingEmailColumnSelect');
                if (columnSelect) {
                    columnSelect.innerHTML = '<option value="">Selecione uma coluna...</option>';

                    data.columns.forEach(column => {
                        const option = document.createElement('option');
                        option.value = column.name;
                        option.textContent = `${column.name} (${column.non_null_count} valores)`;
                        columnSelect.appendChild(option);
                    });

                    columnSelect.disabled = false;
                }

                const uploadBtn = document.getElementById('uploadMarketingBtn');
                if (uploadBtn) {
                    uploadBtn.disabled = false;
                }

                // Show preview
                if (data.columns.length > 0) {
                    showMarketingColumnPreview(data.columns[0]);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('‚ùå Erro ao processar arquivo Excel.');
            });
    }

    // Show marketing column preview
    function showMarketingColumnPreview(column) {
        const previewDiv = document.getElementById('marketingColumnPreview');
        const infoSpan = document.getElementById('marketingColumnInfo');

        if (column) {
            const sampleText = column.sample_values.slice(0, 3).join(', ');
            infoSpan.innerHTML = `
                <strong>${column.name}</strong><br>
                ${column.non_null_count} valores n√£o vazios<br>
                Amostra: ${sampleText}${column.sample_values.length > 3 ? '...' : ''}
            `;
            previewDiv.style.display = 'block';
        } else {
            previewDiv.style.display = 'none';
        }
    }

    // Enhanced upload function with better error handling
    function uploadMarketingExcelEmails() {
        const fileInput = document.getElementById('marketingExcelFile');
        const columnSelect = document.getElementById('marketingEmailColumnSelect');
        const sheetSelect = document.getElementById('marketingSheetSelect');
        const listNameInput = document.getElementById('listName');
        const replaceExistingCheckbox = document.getElementById('replaceExistingList');

        const file = fileInput.files[0];
        const selectedColumn = columnSelect.value;
        const selectedSheet = sheetSelect.value;
        const listName = listNameInput.value.trim();
        const replaceExisting = replaceExistingCheckbox.checked;

        if (!file) {
            alert('‚ùå Por favor, selecione um arquivo Excel primeiro.');
            return;
        }

        if (!selectedSheet) {
            alert('‚ùå Por favor, selecione uma planilha primeiro.');
            return;
        }

        if (!selectedColumn) {
            alert('‚ùå Por favor, selecione uma coluna que cont√©m os emails.');
            return;
        }

        if (!listName) {
            alert('‚ùå Por favor, insira um nome para a lista.');
            return;
        }

        // Check for duplicates and warn user
        const existingList = existingEmailLists.find(list => list.list_name === listName);
        if (existingList && !replaceExisting) {
            const confirmMessage = `‚ö†Ô∏è A lista "${listName}" j√° existe com ${existingList.email_count} emails.\n\nEscolha uma op√ß√£o:\n- Clique OK para adicionar novos emails √† lista existente\n- Clique Cancelar e marque "Substituir lista existente" para substituir completamente\n- Clique Cancelar e altere o nome da lista para criar uma nova`;

            if (!confirm(confirmMessage)) {
                return;
            }
        }

        const formData = new FormData();
        formData.append('excel_file', file);
        formData.append('sheet_name', selectedSheet);
        formData.append('email_column', selectedColumn);
        formData.append('list_name', listName);
        formData.append('replace_existing', replaceExisting ? 'true' : 'false');

        // Show loading state
        const uploadBtn = document.getElementById('uploadMarketingBtn');
        const originalText = uploadBtn.innerHTML;
        const uploadProgress = document.getElementById('uploadProgress');

        uploadBtn.innerHTML = '‚è≥ Processando...';
        uploadBtn.disabled = true;
        uploadProgress.style.display = 'block';

        fetch('{{ url_for("upload_marketing_emails_excel") }}', {
            method: 'POST',
            body: formData
        })
            .then(async response => {
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || `HTTP ${response.status}`);
                }

                return data;
            })
            .then(data => {
                if (data.error) {
                    console.error('Upload error:', data);
                    alert(`‚ùå Erro: ${data.error}`);
                    return;
                }

                // Show success message with details
                let message = `‚úÖ ${data.message}`;
                if (data.details) {
                    message += `\n\nDetalhes:\n`;
                    message += `‚Ä¢ ${data.details.successful_inserts} emails adicionados\n`;
                    message += `‚Ä¢ ${data.details.duplicates_skipped} duplicados ignorados\n`;
                    message += `‚Ä¢ ${data.details.errors} erros\n`;
                    message += `‚Ä¢ Total processado: ${data.details.total_processed}`;
                    if (data.details.invalid_emails_found > 0) {
                        message += `\n‚Ä¢ ${data.details.invalid_emails_found} emails inv√°lidos encontrados no arquivo`;
                    }
                }
                
                alert(message);
                
                // Refresh the lists display
                fetch('{{ url_for("get_marketing_email_lists") }}')
                    .then(response => response.json())
                    .then(listsData => {
                        if (!listsData.error) {
                            updateExistingListsDisplay(listsData.lists);
                            existingEmailLists = listsData.lists;
                        }
                    })
                    .catch(error => {
                        console.error('Error refreshing lists:', error);
                    });
            })
            .catch(error => {
                console.error('Error:', error);
                alert(`‚ùå Erro ao processar arquivo Excel: ${error.message}`);
            })
            .finally(() => {
                // Always restore button state and hide progress bar
                const uploadBtn = document.getElementById('uploadMarketingBtn');
                const uploadProgress = document.getElementById('uploadProgress');
                
                uploadBtn.innerHTML = 'üì• Carregar';
                uploadBtn.disabled = false;
                uploadProgress.style.display = 'none';
            });
    }

    function deleteEmailList(listName) {
        if (!confirm(`Tem certeza que deseja remover a lista "${listName}"? Esta a√ß√£o n√£o pode ser desfeita.`)) {
            return;
        }

        const formData = new FormData();
        formData.append('list_name', listName);

        fetch('{{ url_for("delete_marketing_email_list") }}', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(`‚ùå Erro: ${data.error}`);
                    return;
                }

                alert(`‚úÖ ${data.message}`);

                // Refresh the lists display without page reload
                fetch('{{ url_for("get_marketing_email_lists") }}')
                    .then(response => response.json())
                    .then(listsData => {
                        if (!listsData.error) {
                            updateExistingListsDisplay(listsData.lists);
                        }
                    })
                    .catch(error => {
                        console.error('Error refreshing lists:', error);
                    });
            })
            .catch(error => {
                console.error('Error:', error);
                alert('‚ùå Erro ao remover lista de emails.');
            });
    }


    // Handle marketing Excel file input change
    const marketingExcelFileInput = document.getElementById('marketingExcelFile');
    if (marketingExcelFileInput) {
        marketingExcelFileInput.addEventListener('change', function () {
            const file = this.files[0];
            if (file) {
                // Reset form when new file is selected
                const columnSelect = document.getElementById('marketingEmailColumnSelect');
                if (columnSelect) {
                    columnSelect.innerHTML = '<option value="">Selecione uma coluna...</option>';
                    columnSelect.disabled = true;
                }

                const uploadBtn = document.getElementById('uploadMarketingBtn');
                if (uploadBtn) {
                    uploadBtn.disabled = true;
                }

                const previewDiv = document.getElementById('marketingColumnPreview');
                if (previewDiv) {
                    previewDiv.style.display = 'none';
                }

                currentMarketingExcelFile = null;
                currentMarketingColumns = null;
            }
        });
    }

    // Handle marketing column selection change
    const marketingColumnSelect = document.getElementById('marketingEmailColumnSelect');
    if (marketingColumnSelect) {
        marketingColumnSelect.addEventListener('change', function () {
            const selectedColumn = this.value;
            if (selectedColumn && currentMarketingColumns) {
                const column = currentMarketingColumns.find(col => col.name === selectedColumn);
                showMarketingColumnPreview(column);
            } else {
                const previewDiv = document.getElementById('marketingColumnPreview');
                if (previewDiv) {
                    previewDiv.style.display = 'none';
                }
            }
        });
    }

    // Load existing email lists when page loads
    document.addEventListener('DOMContentLoaded', function() {
        loadExistingEmailLists();
    });

    // Update existing lists display without page reload
    function updateExistingListsDisplay(lists) {
        const container = document.getElementById('existingListsContainer');

        if (lists.length === 0) {
            container.innerHTML = `
                <div class="text-center text-muted">
                    <p>Nenhuma lista de emails encontrada.</p>
                    <small>Fa√ßa upload de um arquivo Excel para criar sua primeira lista.</small>
                </div>
            `;
            return;
        }

        let html = '';
        lists.forEach(list => {
            html += `
                <div class="list-item mb-3 p-3 border rounded">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">${list.list_name}</h6>
                            <small class="text-muted">${list.email_count} emails</small>
                        </div>
                        <div>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="loadEmailList('${list.list_name}')">
                                üì• Carregar
                            </button>
                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="deleteEmailList('${list.list_name}')">
                                üóëÔ∏è Remover
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });

        container.innerHTML = html;
    }

    // Email Search Functionality
    let searchMatches = [];
    let currentMatchIndex = -1;
    let lastSearchTerm = '';

    function searchEmailInTextarea() {
        const searchBox = document.getElementById('emailSearchBox');
        const textarea = document.getElementById('bulkEmails');
        const searchResults = document.getElementById('searchResults');
        const searchResultText = document.getElementById('searchResultText');
        
        const searchTerm = searchBox.value.trim().toLowerCase();
        
        // Clear previous search if search term is empty
        if (!searchTerm) {
            searchResults.style.display = 'none';
            searchBox.className = searchBox.className.replace(/\b(has-results|no-results)\b/g, '');
            searchMatches = [];
            currentMatchIndex = -1;
            lastSearchTerm = '';
            return;
        }
        
        // Always search when term changes
        lastSearchTerm = searchTerm;
        currentMatchIndex = -1;
        searchMatches = [];
        
        const lines = textarea.value.split('\n');
        
        // Find all matches
        lines.forEach((line, lineIndex) => {
            const trimmedLine = line.trim();
            const lowerLine = line.toLowerCase();
            
            if (trimmedLine && lowerLine.includes(searchTerm)) {
                // Calculate character position in textarea
                let charPosition = 0;
                for (let i = 0; i < lineIndex; i++) {
                    charPosition += lines[i].length + 1; // +1 for newline character
                }
                
                const matchStartInLine = lowerLine.indexOf(searchTerm);
                if (matchStartInLine !== -1) {
                    const match = {
                        lineIndex: lineIndex,
                        charStart: charPosition,
                        charEnd: charPosition + line.length,
                        line: trimmedLine,
                        matchStart: charPosition + matchStartInLine,
                        matchEnd: charPosition + matchStartInLine + searchTerm.length,
                        originalLine: line // Keep original line with spaces
                    };
                    
                    searchMatches.push(match);
                }
            }
        });
        

        
        // Update search results display
        if (searchMatches.length > 0) {
            currentMatchIndex = 0;
            searchResults.style.display = 'block';
            searchBox.className = searchBox.className.replace(/\b(has-results|no-results)\b/g, '') + ' has-results';
            updateSearchResultsDisplay();
            highlightMatch(currentMatchIndex);
        } else {
            searchResults.style.display = 'block';
            searchBox.className = searchBox.className.replace(/\b(has-results|no-results)\b/g, '') + ' no-results';
            searchResultText.textContent = `Nenhum resultado encontrado para "${searchBox.value}"`;
        }
    }

    function updateSearchResultsDisplay() {
        const searchResultText = document.getElementById('searchResultText');
        const searchBox = document.getElementById('emailSearchBox');
        
        if (searchMatches.length > 0) {
            const currentMatch = searchMatches[currentMatchIndex];
            const matchPreview = currentMatch.line.length > 30 ? 
                currentMatch.line.substring(0, 30) + '...' : 
                currentMatch.line;
            
            searchResultText.innerHTML = `
                <strong>${currentMatchIndex + 1} de ${searchMatches.length}</strong> resultados para "<em>${searchBox.value}</em>"
                <br><small class="text-muted">Linha ${currentMatch.lineIndex + 1}: ${matchPreview}</small>
            `;
        }
    }

    function highlightMatch(matchIndex) {
        if (matchIndex < 0 || matchIndex >= searchMatches.length) return;
        
        const textarea = document.getElementById('bulkEmails');
        const match = searchMatches[matchIndex];
        

        
        // Focus textarea briefly to ensure selection works
        const wasSearchBoxFocused = document.activeElement === document.getElementById('emailSearchBox');
        textarea.focus();
        
        // Set selection to highlight the entire line containing the match
        textarea.setSelectionRange(match.charStart, match.charEnd);
        
        // Calculate scroll position more accurately
        const textBeforeMatch = textarea.value.substring(0, match.charStart);
        const linesBefore = textBeforeMatch.split('\n').length - 1;
        
        // Get textarea properties for better scroll calculation
        const style = window.getComputedStyle(textarea);
        const lineHeight = parseInt(style.lineHeight) || 20;
        const paddingTop = parseInt(style.paddingTop) || 0;
        
        // Scroll to show the match with some context
        const targetScrollTop = Math.max(0, (linesBefore - 1) * lineHeight - paddingTop);
        textarea.scrollTop = targetScrollTop;
        
        // Return focus to search box if it was focused before
        if (wasSearchBoxFocused) {
            setTimeout(() => {
                document.getElementById('emailSearchBox').focus();
            }, 100);
        }
        

    }

    function navigateSearchResults(direction) {
        if (searchMatches.length === 0) return;
        
        if (direction === 'next') {
            currentMatchIndex = (currentMatchIndex + 1) % searchMatches.length;
        } else if (direction === 'prev') {
            currentMatchIndex = currentMatchIndex <= 0 ? searchMatches.length - 1 : currentMatchIndex - 1;
        }
        
        updateSearchResultsDisplay();
        highlightMatch(currentMatchIndex);
    }

    function handleSearchNavigation(event) {
        if (event.key === 'Enter') {
            event.preventDefault();
            if (event.shiftKey) {
                navigateSearchResults('prev');
            } else {
                navigateSearchResults('next');
            }
        } else if (event.key === 'Escape') {
            clearEmailSearch();
        }
    }

    function clearEmailSearch() {
        const searchBox = document.getElementById('emailSearchBox');
        const searchResults = document.getElementById('searchResults');
        const textarea = document.getElementById('bulkEmails');
        
        searchBox.value = '';
        searchBox.className = searchBox.className.replace(/\b(has-results|no-results)\b/g, '');
        searchResults.style.display = 'none';
        searchMatches = [];
        currentMatchIndex = -1;
        lastSearchTerm = '';
        
        // Clear selection in textarea
        if (textarea.selectionStart !== textarea.selectionEnd) {
            textarea.setSelectionRange(textarea.selectionEnd, textarea.selectionEnd);
        }
    }

    // Add global keyboard event listener to handle typing when textarea is focused
    document.addEventListener('DOMContentLoaded', function() {
        const searchBox = document.getElementById('emailSearchBox');
        const textarea = document.getElementById('bulkEmails');
        
        // Prevent textarea from stealing focus during search
        textarea.addEventListener('focus', function(e) {
            // If search box has content and user didn't explicitly click on textarea
            if (searchBox.value.trim() && searchMatches.length > 0) {
                // Check if this focus event was triggered by our search highlighting
                if (document.activeElement === textarea && !e.isTrusted) {
                    return; // Allow programmatic focus for highlighting
                }
            }
        });
        
        // Global keydown listener for quick search access
        document.addEventListener('keydown', function(e) {
            // If user presses Ctrl+F or Cmd+F, focus the search box instead of browser search
            if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                e.preventDefault();
                searchBox.focus();
            }
        });
        
        // Improve search box behavior
        searchBox.addEventListener('focus', function() {
            // Only select all text if user clicked on the search box, not if auto-focused
            // This prevents the text selection issue when typing
        });
    });

    // Test function to add sample emails for testing search
    function addTestEmails() {
        const textarea = document.getElementById('bulkEmails');
        const testEmails = `joao.silva@gmail.com
maria.santos@hotmail.com
pedro.oliveira@yahoo.com
ana.costa@outlook.com
carlos.ferreira@gmail.com
lucia.pereira@company.com
rafael.almeida@test.com
fernanda.rodrigues@example.org
gustavo.lima@domain.net
patricia.souza@email.com
ricardo.barbosa@gmail.com
camila.martins@hotmail.com
bruno.carvalho@yahoo.com
juliana.nascimento@outlook.com
diego.ribeiro@company.com`;
        
        if (textarea.value.trim()) {
            if (confirm('Isso ir√° substituir os emails existentes. Continuar?')) {
                textarea.value = testEmails;
            }
        } else {
            textarea.value = testEmails;
        }
        
        // Clear any existing search
        clearEmailSearch();
        
        alert('‚úÖ Emails de teste adicionados! Agora voc√™ pode testar a funcionalidade de pesquisa.');
    }

    // Debug function to test upload parameters
    function debugUploadParams() {
        const fileInput = document.getElementById('marketingExcelFile');
        const columnSelect = document.getElementById('marketingEmailColumnSelect');
        const sheetSelect = document.getElementById('marketingSheetSelect');
        const listNameInput = document.getElementById('listName');
        const replaceExistingCheckbox = document.getElementById('replaceExistingList');

        const file = fileInput.files[0];
        const selectedColumn = columnSelect.value;
        const selectedSheet = sheetSelect.value;
        const listName = listNameInput.value.trim();
        const replaceExisting = replaceExistingCheckbox.checked;

        if (!file) {
            alert('‚ùå Por favor, selecione um arquivo Excel primeiro para testar.');
            return;
        }

        const formData = new FormData();
        formData.append('excel_file', file);
        formData.append('sheet_name', selectedSheet);
        formData.append('email_column', selectedColumn);
        formData.append('list_name', listName);
        formData.append('replace_existing', replaceExisting ? 'true' : 'false');

        fetch('/debug-upload-params', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            console.log('Debug response:', data);
            
            let message = 'üîç Debug Upload Parameters:\n\n';
            message += `Files: ${JSON.stringify(data.files)}\n`;
            message += `Form Data: ${JSON.stringify(data.form_data, null, 2)}\n`;
            message += `File Details: ${JSON.stringify(data.file_details, null, 2)}`;
            
            alert(message);
        })
        .catch(error => {
            console.error('Debug error:', error);
            alert(`‚ùå Debug error: ${error.message}`);
        });
    }

    // Debug function to test Excel content reading
    function debugExcelContent() {
        const fileInput = document.getElementById('marketingExcelFile');
        const columnSelect = document.getElementById('marketingEmailColumnSelect');
        const sheetSelect = document.getElementById('marketingSheetSelect');

        const file = fileInput.files[0];
        const selectedColumn = columnSelect.value;
        const selectedSheet = sheetSelect.value;

        if (!file) {
            alert('‚ùå Por favor, selecione um arquivo Excel primeiro para testar.');
            return;
        }

        const formData = new FormData();
        formData.append('excel_file', file);
        formData.append('sheet_name', selectedSheet);
        formData.append('email_column', selectedColumn);

        fetch('/debug-excel-content', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            console.log('Excel debug response:', data);
            
            let message = 'üìä Debug Excel Content:\n\n';
            message += `File: ${data.filename}\n`;
            message += `Sheet: ${data.sheet_name || 'Default'}\n`;
            message += `Shape: ${data.shape[0]} rows x ${data.shape[1]} columns\n`;
            message += `Columns: ${data.columns.join(', ')}\n\n`;
            
            message += 'Sample Data:\n';
            for (const [col, samples] of Object.entries(data.sample_data)) {
                message += `${col}: ${samples.join(', ')}\n`;
            }
            
            alert(message);
        })
        .catch(error => {
            console.error('Excel debug error:', error);
            alert(`‚ùå Excel debug error: ${error.message}`);
        });
    }




</script>
