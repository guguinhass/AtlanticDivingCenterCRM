<!doctype html>
<html>
<head>
    <title>Marketing Emails - CRM Atlantic Diving Center</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <style>
        .chat-container {
            height: 400px;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            background-color: #f8f9fa;
        }
        .chat-messages {
            height: 350px;
            overflow-y: auto;
            padding: 15px;
        }
        .chat-input {
            height: 50px;
            border-top: 1px solid #dee2e6;
            padding: 10px;
            background-color: white;
        }
        .message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 15px;
            max-width: 80%;
        }
        .message.sent {
            background-color: #007bff;
            color: white;
            margin-left: auto;
        }
        .message.received {
            background-color: #e9ecef;
            color: #212529;
        }
        .message.system {
            background-color: #ffc107;
            color: #212529;
            text-align: center;
            max-width: 100%;
        }
        .message.error {
            background-color: #dc3545;
            color: white;
            text-align: center;
            max-width: 100%;
        }
        .message.success {
            background-color: #28a745;
            color: white;
            text-align: center;
            max-width: 100%;
        }
    </style>
</head>
<body class="bg-light">

<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Marketing Emails</h2>
        <a href="{{ url_for('index') }}" class="btn btn-secondary">Voltar</a>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <form method="post" id="marketingForm">
        <!-- Email Editor Section (Top) -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">üìß Composer de Email Marketing</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Assunto do Email:</label>
                            <input type="text" name="subject" class="form-control" required placeholder="Ex: Novidades da Atlantic Diving Center">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Destinat√°rios:</label>
                            <div class="form-control-plaintext">
                                <span class="badge bg-info">{{ client_count }} clientes</span>
                                <small class="text-muted ms-2">Todos os clientes na base de dados</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Conte√∫do do Email:</label>
                    <div id="emailEditor" style="height: 300px;"></div>
                    <input type="hidden" name="content" id="emailContent">
                    <input type="hidden" name="include_database" id="includeDatabaseHidden">
                </div>

                <div class="d-flex justify-content-between align-items-center">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="previewMode" checked>
                        <label class="form-check-label" for="previewMode">
                            Modo de pr√©-visualiza√ß√£o
                        </label>
                    </div>
                    <button type="submit" class="btn btn-primary btn-lg" onclick="sendMarketingEmail()">
                        üì§ Enviar Marketing Email
                    </button>
                </div>
            </div>
        </div>

        <!-- Bulk Email Input Section (Bottom) -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">üìß Lista de Emails para Marketing</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <div class="mb-3">
                            <label class="form-label">Emails (um por linha ou separados por v√≠rgula):</label>
                            <textarea class="form-control" id="bulkEmails" name="bulk_emails" rows="8" 
                                placeholder="Cole aqui os emails para marketing...
Exemplo:
joao@email.com
maria@email.com
pedro@email.com

Ou separados por v√≠rgula:
joao@email.com, maria@email.com, pedro@email.com">{{ saved_emails }}</textarea>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">Op√ß√µes:</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="includeDatabase" checked>
                                <label class="form-check-label" for="includeDatabase">
                                    Incluir clientes da base de dados
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="validateEmails" checked>
                                <label class="form-check-label" for="validateEmails">
                                    Validar formato dos emails
                                </label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="validateEmailList()">
                                üîç Validar Emails
                            </button>
                            <button type="button" class="btn btn-outline-info btn-sm" onclick="clearEmailList()">
                                üóëÔ∏è Limpar Lista
                            </button>
                        </div>
                        <div id="emailStats" class="alert alert-info" style="display: none;">
                            <small>
                                <strong>üìä Estat√≠sticas:</strong><br>
                                <span id="validEmails">0</span> emails v√°lidos<br>
                                <span id="invalidEmails">0</span> emails inv√°lidos
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // Initialize Quill editor
    var quill = new Quill('#emailEditor', {
        theme: 'snow',
        modules: {
            toolbar: [
                ['bold', 'italic', 'underline'],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                ['link', 'image'],
                ['clean']
            ]
        },
        placeholder: 'Escreva o conte√∫do do seu email marketing aqui...'
    });

    // Email validation function
    function isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email.trim());
    }

    // Parse emails from textarea
    function parseEmails(emailText) {
        if (!emailText.trim()) return [];
        
        const emails = [];
        const lines = emailText.trim().split('\n');
        
        for (let line of lines) {
            if (line.trim()) {
                // Split by commas if present
                if (line.includes(',')) {
                    const emailsInLine = line.split(',').map(email => email.trim()).filter(email => email.length > 0);
                    emails.push(...emailsInLine);
                } else {
                    emails.push(line.trim());
                }
            }
        }
        
        return emails;
    }

    // Validate email list
    function validateEmailList() {
        const emailText = document.getElementById('bulkEmails').value;
        const emails = parseEmails(emailText);
        
        let validCount = 0;
        let invalidCount = 0;
        const validEmails = [];
        const invalidEmails = [];
        
        emails.forEach(email => {
            if (isValidEmail(email)) {
                validCount++;
                validEmails.push(email);
            } else {
                invalidCount++;
                invalidEmails.push(email);
            }
        });
        
        // Update statistics
        document.getElementById('validEmails').textContent = validCount;
        document.getElementById('invalidEmails').textContent = invalidCount;
        document.getElementById('emailStats').style.display = 'block';
        
        // Show results
        let message = `<strong>üîç Valida√ß√£o de Emails:</strong><br>`;
        message += `‚úÖ ${validCount} emails v√°lidos<br>`;
        if (invalidCount > 0) {
            message += `‚ùå ${invalidCount} emails inv√°lidos: ${invalidEmails.join(', ')}`;
        }
        
        alert(message);
    }

    // Clear email list
    function clearEmailList() {
        if (confirm('Tem certeza que deseja limpar a lista de emails? Esta a√ß√£o ir√° remover permanentemente todos os emails salvos.')) {
            // Create a form to submit the clear request
            var form = document.createElement('form');
            form.method = 'POST';
            form.action = '{{ url_for("clear_marketing_emails") }}';
            
            document.body.appendChild(form);
            form.submit();
        }
    }

    // Send marketing email function
    function sendMarketingEmail() {
        const subject = document.querySelector('input[name="subject"]').value;
        const content = quill.root.innerHTML;
        const includeDatabase = document.getElementById('includeDatabase').checked;
        const validateEmails = document.getElementById('validateEmails').checked;
        
        if (!subject.trim()) {
            alert('‚ùå Erro: Por favor, preencha o assunto do email.');
            return false;
        }
        
        if (!content.trim() || content === '<p><br></p>') {
            alert('‚ùå Erro: Por favor, preencha o conte√∫do do email.');
            return false;
        }

        // Get bulk emails
        const emailText = document.getElementById('bulkEmails').value;
        const bulkEmails = parseEmails(emailText);
        
        // Validate emails if option is checked
        if (validateEmails && bulkEmails.length > 0) {
            const invalidEmails = bulkEmails.filter(email => !isValidEmail(email));
            if (invalidEmails.length > 0) {
                alert(`‚ùå Erro: Emails inv√°lidos encontrados: ${invalidEmails.join(', ')}`);
                return false;
            }
        }

        // Check if we have any recipients
        if (!includeDatabase && bulkEmails.length === 0) {
            alert('‚ùå Erro: Nenhum destinat√°rio selecionado. Adicione emails ou marque "Incluir clientes da base de dados".');
            return false;
        }

        // Update hidden inputs
        document.getElementById('emailContent').value = content;
        document.getElementById('includeDatabaseHidden').value = includeDatabase ? 'on' : 'off';
        
        // Show confirmation
        const databaseCount = parseInt('{{ client_count }}');
        const totalRecipients = includeDatabase ? (databaseCount + bulkEmails.length) : bulkEmails.length;
        const confirmMessage = `üì§ Confirmar envio de marketing email para ${totalRecipients} destinat√°rios?`;
        
        if (confirm(confirmMessage)) {
            return true;
        } else {
            return false;
        }
    }

    // Handle form submission
    document.getElementById('marketingForm').addEventListener('submit', function(e) {
        if (!sendMarketingEmail()) {
            e.preventDefault();
        }
    });

    // Auto-validate emails when typing
    document.getElementById('bulkEmails').addEventListener('input', function() {
        const emailText = this.value;
        if (emailText.trim()) {
            const emails = parseEmails(emailText);
            const validCount = emails.filter(email => isValidEmail(email)).length;
            const invalidCount = emails.length - validCount;
            
            if (emails.length > 0) {
                document.getElementById('validEmails').textContent = validCount;
                document.getElementById('invalidEmails').textContent = invalidCount;
                document.getElementById('emailStats').style.display = 'block';
            } else {
                document.getElementById('emailStats').style.display = 'none';
            }
        } else {
            document.getElementById('emailStats').style.display = 'none';
        }
    });
</script>

</body>
</html> 