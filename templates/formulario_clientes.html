<!doctype html>
<html>
<head>
    <title>CRM Atlantic Diving Center</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <meta http-equiv="refresh" content="30" charset="utf-8">
    <style>
        .text-success {
            color: #28a745 !important;
        }

        .text-danger {
            color: #dc3545 !important;
        }

        .table-update {
            transition: background-color 1.5s ease;
        }

        .highlight {
            background-color: rgba(40, 167, 69, 0.2);
        }
    </style>
</head>
<body class="bg-light">

<div class="container mt-5">
    <div class="d-flex justify-content-start gap-3 mb-4">

        <a href="{{ url_for('exportar_emails') }}" class="btn btn-success">
            Exportar para Excel
        </a>


        <form id="enviar-todos-form" action="{{ url_for('enviar_manual_todos') }}" method="POST">
            <button type="submit" class="btn btn-success">
                Enviar email para todos
            </button>
        </form>
    </div>


    <h2 class="text-center mb-4">Cadastro de Cliente</h2>

    {% if mensagem %}
        <div class="alert alert-danger text-center">{{ mensagem }}</div>
    {% endif %}

    <form method="post" class="p-4 bg-white rounded shadow-sm">
        <div class="mb-3">
            <label class="form-label">Nome:</label>
            <input type="text" name="nome" class="form-control" required>
        </div>

        <div class="mb-3">
            <label class="form-label">Nº de Mergulhos:</label>
            <input type="number" name="num_mergulho" class="form-control" required min="1">
        </div>

        <div class="mb-3">
            <label class="form-label">Email:</label>
            <input type="email" name="email" class="form-control" required>
        </div>

        <div class="mb-3">
            <label class="form-label">Data do Mergulho:</label>
            <input type="date" name="data_mergulho" class="form-control" required>
        </div>

        <div class="mb-3">
            <label class="form-label">Valor:</label>
            <div class="input-group mb-2">
                <input type="number" step="0.01" name="valor_fatura_base" id="valor_fatura_base" class="form-control" required min="0" placeholder="Valor sem IVA">
                <span class="input-group-text">€</span>
            </div>
            <div class="form-text">Com IVA (22%): <span id="valor_com_iva" class="fw-bold">0.00</span> €</div>
        </div>
        <div class="mb-3">
            <label class="form-label">Valor Final (pode editar):</label>
            <div class="input-group">
                <input type="number" step="0.01" name="valor_fatura" id="valor_fatura" class="form-control" required min="0" placeholder="Valor final a ser salvo">
                <span class="input-group-text">€</span>
            </div>
            <div class="form-text">Este valor será salvo na tabela.</div>
        </div>

        <div class="mb-3">
            <label class="form-label">Nacionalidade:</label>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="nacionalidade" id="português" value="português"
                       checked>
                <label class="form-check-label" for="português">Português</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="nacionalidade" id="inglês" value="inglês">
                <label class="form-check-label" for="inglês">Inglês</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="nacionalidade" id="francês" value="francês">
                <label class="form-check-label" for="francês">Francês</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="nacionalidade" id="alemão" value="alemão">
                <label class="form-check-label" for="alemão">Alemão</label>
            </div>
        </div>

        <div class="text-center">
            <input type="submit" value="Cadastrar" class="btn btn-primary px-4">
        </div>
    </form>

    <h2 class="text-center mt-5 mb-4">Clientes Cadastrados</h2>

    <div class="table-responsive">
        <table class="table table-bordered table-striped table-hover">
            <thead class="table-dark">
            <tr>
                <th>Adicionado por</th>
                <th>Nome</th>
                <th>Email</th>
                <th>Nº Mergulhos</th>
                <th>Data Mergulho</th>
                <th>Valor (€)</th>
                <th>Nacionalidade</th>
                <th>1º Email</th>
                <th>2º Email</th>
                <th>Email Manual</th>
                <th>Ações</th>
            </tr>
            </thead>
            <tbody>
            {% for cliente in clientes %}
                <tr>
                    <td>{{ cliente.adicionado_por if cliente.adicionado_por else 'Desconhecido' }}</td>
                    <td>{{ cliente.nome }}</td>
                    <td>{{ cliente.email }}</td>
                    <td>{{ cliente.num_mergulho }}</td>
                    <td>{{ cliente.formatted_date }}</td>
                    <td>{{ "%.2f"|format(cliente.valor_fatura) }} €</td>
                    <td>{{ cliente.nacionalidade.capitalize() }}</td>
                    <td>{{ 'Sim' if cliente.primeiro_email_enviado else 'Não' }}</td>
                    <td>{{ 'Sim' if cliente.segundo_email_enviado else 'Não' }}</td>
                    <td>{{ 'Sim' if cliente.email_manual_enviado else 'Não' }}</td>
                    <td class="d-flex gap-2">
                        <form action="{{ url_for('enviar_manual', email=cliente.email) }}" method="post">
                            <button type="submit" class="btn btn-sm btn-success" {% if cliente.email_manual_enviado %}disabled{% endif %}>Enviar Email</button>
                        </form>
                        <form action="{{ url_for('remover_cliente', email=cliente.email) }}" method="post"
                              onsubmit="return confirm('Tem certeza que deseja remover {{ cliente.nome }}?');">
                            <button type="submit" class="btn btn-sm btn-danger">Remover</button>
                        </form>
                    </td>
                </tr>
            {% else %}
                <tr>
                    <td colspan="9" class="text-center">Nenhum cliente cadastrado</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<div id="loading" class="text-center my-3" style="display: none;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Carregando...</span>
    </div>
    <p>Atualizando dados...</p>
</div>

<script>

    function atualizarTabela() {
        document.getElementById('loading').style.display = 'block';

        fetch('/atualizar-tabela')
            .then(response => {
                if (!response.ok) throw new Error('Erro na rede');
                return response.text();
            })
            .then(html => {
                document.querySelector('tbody').innerHTML = html;
                configurarEventosForms();
            })
            .catch(error => {
                console.error('Erro:', error);
            })
            .finally(() => {
                document.getElementById('loading').style.display = 'none';
            });
    }


    function configurarEventosForms() {

        document.querySelectorAll('.form-enviar').forEach(form => {
            form.addEventListener('submit', function (e) {
                e.preventDefault();
                enviarFormulario(this);
            });
        });


        document.querySelectorAll('.form-remover').forEach(form => {
            form.addEventListener('submit', function (e) {
                if (!confirm('Tem certeza que deseja remover este cliente?')) {
                    e.preventDefault();
                    return;
                }
                enviarFormulario(this);
            });
        });
    }


    function enviarFormulario(form) {
        fetch(form.action, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
            .then(response => {
                if (response.redirected) {
                    window.location.href = response.url;
                } else {
                    atualizarTabela();
                }
            })
            .catch(error => console.error('Erro:', error));
    }


    setInterval(atualizarTabela, 10000);


    document.addEventListener('DOMContentLoaded', function () {
        configurarEventosForms();
        atualizarTabela();
        // Add confirmation for 'Enviar email para todos' form
        var enviarTodosForm = document.getElementById('enviar-todos-form');
        if (enviarTodosForm) {
            enviarTodosForm.addEventListener('submit', function(e) {
                if (!confirm('Deseja enviar email para TODOS os clientes?')) {
                    e.preventDefault();
                }
            });
        }
        // IVA calculation logic
        var baseInput = document.getElementById('valor_fatura_base');
        var ivaSpan = document.getElementById('valor_com_iva');
        var finalInput = document.getElementById('valor_fatura');
        function updateIVA() {
            var base = parseFloat(baseInput.value) || 0;
            var comIva = (base * 1.22).toFixed(2);
            ivaSpan.textContent = comIva;
            if (!finalInput.value || parseFloat(finalInput.value) === 0) {
                finalInput.value = comIva;
            }
        }
        baseInput.addEventListener('input', updateIVA);
        // Initialize on load
        updateIVA();
    });
</script>
</body>
</html>