<!doctype html>
<html>
<head>
    <title>CRM Atlantic Diving Center</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Add Quill CSS in <head> -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

    <style>
        .text-success {
            color: #28a745 !important;
        }

        .text-danger {
            color: #dc3545 !important;
        }

        .table-update {
            transition: background-color 1.5s ease;
        }

        .highlight {
            background-color: rgba(40, 167, 69, 0.2);
        }

        .iva-fade {
            opacity: 0;
            width: 0;
            transition: opacity 0.5s, width 0.5s;
            overflow: hidden;
            display: flex;
            align-items: center;
        }

        .iva-fade.show {
            opacity: 1 !important;
            width: 320px !important; /* Adjust as needed */
            margin-left: 0.5rem;
        }
    </style>
</head>
<body class="bg-light">

<div class="container mt-5">
    <!-- Header with logout button -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">Cadastro de Cliente</h2>
        <div class="d-flex align-items-center gap-2">
            <a href="{{ url_for('logout') }}" class="btn btn-outline-danger btn-sm">
                <i class="fas fa-sign-out-alt"></i> Logout
            </a>
        </div>
    </div>

    {% if mensagem %}
        <div class="alert alert-danger text-center">{{ mensagem }}</div>
    {% endif %}

    <div class="d-flex justify-content-start gap-3 mb-4">
        {% if session.get('is_admin') %}
            <form id="enviar-todos-form" action="{{ url_for('enviar_manual_todos') }}" method="POST" class="m-0">
                <button type="submit" class="btn btn-success">Enviar email para todos</button>
            </form>
            <a href="{{ url_for('exportar_emails') }}" class="btn btn-success">Exportar para Excel</a>
            <a href="{{ url_for('manage_users') }}" class="btn btn-success">Gerir Utilizadores</a>
            <form id="editar-primeiro-email" action="{{ url_for('editar_primeiro_email') }}" method="POST" class="m-0">
                <button type="submit" class="btn btn-success" onclick="console.log('Editar 1ºemail clicked')">Editar
                    1ºemail
                </button>
            </form>
            <form id="editar-segundo-email" action="{{ url_for('editar_segundo_email') }}" method="POST" class="m-0">
                <button type="submit" class="btn btn-success" onclick="console.log('Editar 2ºemail clicked')">Editar
                    2ºemail
                </button>
            </form>
            <a href="{{ url_for('marketing_emails') }}" class="btn btn-warning">Marketing Emails</a>
        {% endif %}
    </div>

    <form method="post" class="p-4 bg-white rounded shadow-sm">
        <div class="mb-3">
            <label class="form-label">Nome:</label>
            <input type="text" name="nome" class="form-control" required>
        </div>

        <div class="mb-3">
            <label class="form-label">Nº de Mergulhos:</label>
            <input type="number" name="num_mergulho" class="form-control" required min="1">
        </div>

        <div class="mb-3">
            <label class="form-label">Email:</label>
            <input type="email" name="email" class="form-control" required>
        </div>

        <div class="mb-3">
            <label class="form-label">Data do Mergulho:</label>
            <input type="date" name="data_mergulho" class="form-control" required>
        </div>

        <div class="mb-3">
            <label class="form-label">Valor:</label>
            <div class="input-group mb-2">
                <input type="number" step="0.01" name="valor_fatura_base" id="valor_fatura_base" class="form-control"
                       required min="0" placeholder="Valor sem IVA">
                <span class="input-group-text">€</span>
            </div>
            <div class="form-text">Com IVA: <span id="valor_com_iva" class="fw-bold">0.00</span> €</div>
        </div>

        <div class="mb-3">
            <label class="form-label">IVA:</label>
            <input type="number" name="iva" id="iva" class="form-control" min="0" max="100" step="0.01" value="22"
                   required>
            <div class="form-text">IVA a ser aplicado para este cliente (ex: 22 para 22%)</div>
        </div>

        <div class="mb-3">
            <label class="form-label">Valor Final (pode editar):</label>
            <div class="input-group">
                <input type="number" step="0.01" name="valor_fatura" id="valor_fatura" class="form-control" required
                       min="0" placeholder="Valor final a ser salvo">
                <span class="input-group-text">€</span>
            </div>
            <div class="form-text">Este valor será salvo na tabela. O desconto será aplicado sobre este valor.</div>
        </div>

        <div class="mb-3">
            <label class="form-label">Desconto (%):</label>
            <input type="number" name="desconto" id="desconto" class="form-control" min="0" max="100" step="0.01"
                   placeholder="0">
            <div class="form-text">Opcional. Percentual de desconto a ser aplicado ao valor final acima.</div>
        </div>

        {% if session.get('is_admin') %}
            <div class="mb-3">
                <label class="form-label">Gastos (€):</label>
                <div class="input-group">
                    <input type="number" step="0.01" name="gastos" id="gastos" class="form-control" min="0"
                           placeholder="0.00" value="0">
                    <span class="input-group-text">€</span>
                </div>
            </div>
            <!-- Campo Receita (calculado automaticamente) -->
            <div class="mb-3">
                <label class="form-label">Receita (€):</label>
                <div class="input-group">
                    <input type="number" step="0.01" name="receita" id="receita" class="form-control" readonly>
                    <span class="input-group-text">€</span>
                </div>
                <div class="form-text">Receita = Valor Final - Gastos</div>
            </div>

        {% endif %}

        <div class="mb-3">
            <label class="form-label">Nacionalidade:</label>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="nacionalidade" id="português" value="português"
                       checked>
                <label class="form-check-label" for="português">Português</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="nacionalidade" id="inglês" value="inglês">
                <label class="form-check-label" for="inglês">Inglês</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="nacionalidade" id="francês" value="francês">
                <label class="form-check-label" for="francês">Francês</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="nacionalidade" id="alemão" value="alemão">
                <label class="form-check-label" for="alemão">Alemão</label>
            </div>
        </div>

        <div class="text-center">
            <input type="submit" value="Cadastrar" class="btn btn-primary px-4">
        </div>
    </form>

    <h2 class="text-center mt-5 mb-4">Clientes Cadastrados</h2>
    <button type="button" class="btn btn-primary" onclick="toggleFilterPanel()">Filtrar por Mês</button>
    <p></p>
    <!-- Month Filter -->

    <div id="filterPanel" class="row mb-3" style="display: none;">
        <div class="col-md-6 offset-md-3">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex align-items-center gap-3">
                        <label for="monthFilter" class="form-label mb-0">Filtrar por mês:</label>
                        <select id="monthFilter" class="form-select" style="width: auto;">
                            <option value="">Todos os meses</option>
                            <option value="01">Janeiro</option>
                            <option value="02">Fevereiro</option>
                            <option value="03">Março</option>
                            <option value="04">Abril</option>
                            <option value="05">Maio</option>
                            <option value="06">Junho</option>
                            <option value="07">Julho</option>
                            <option value="08">Agosto</option>
                            <option value="09">Setembro</option>
                            <option value="10">Outubro</option>
                            <option value="11">Novembro</option>
                            <option value="12">Dezembro</option>
                        </select>
                        <button type="button" class="btn btn-primary" onclick="filterByMonth()">Filtrar</button>
                        <button type="button" class="btn btn-secondary" onclick="clearFilter()">Limpar Filtro</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-bordered table-striped table-hover">
            <thead class="table-dark">
            <tr>
                <th>Adicionado por</th>
                <th>Nome</th>
                <th>Email</th>
                <th>Nº Mergulhos</th>
                <th>Data Mergulho</th>
                <th>Valor (€)</th>
                <th>IVA</th>
                <th>Desconto (%)</th>
                {% if session.get('is_admin') %}
                    <th>Gastos (€)</th>
                    <th>Receita (€)</th>
                {% endif %}
                <th>Nacionalidade</th>
                <th>1º Email</th>
                <th>2º Email</th>
                <th>Email Manual</th>
                <th>Ações</th>
            </tr>
            </thead>
            <tbody>
            {% for cliente in clientes %}
                <tr>
                    <td>{{ cliente.adicionado_por if cliente.adicionado_por else 'Desconhecido' }}</td>
                    <td>{{ cliente.nome }}</td>
                    <td>{{ cliente.email }}</td>
                    <td>{{ cliente.num_mergulho }}</td>
                    <td>{{ cliente.formatted_date }}</td>
                    <td>{{ "%.2f"|format(cliente.valor_fatura) }} €</td>
                    <td>{{ "%.0f"|format(cliente.iva * 100) }}%</td>
                    <td>{% if cliente.desconto %}{{ cliente.desconto }}%{% else %}0.0{% endif %}</td>
                    {% if session.get('is_admin') %}
                        <td>
                            <input type="number"
                                   class="form-control form-control-sm gastos-input"
                                   value="{{ '%.2f'|format(cliente.gastos) if cliente.gastos else '0.00' }}"
                                   data-email="{{ cliente.email }}"
                                   style="width: 90px; display: inline-block;"
                                   min="0" step="0.01">
                            €
                            <button type="button" class="btn btn-primary px-4 guardar-btn">Guardar</button>
                        </td>
                        <td>{{ cliente.receita }} €</td>
                    {% endif %}
                    <td>{{ cliente.nacionalidade.capitalize() }}</td>
                    <td>{{ 'Sim' if cliente.primeiro_email_enviado else 'Não' }}</td>
                    <td>{{ 'Sim' if cliente.segundo_email_enviado else 'Não' }}</td>
                    <td>
                        {{ 'Sim' if cliente.email_manual_enviado else 'Não' }}
                        <form action="{{ url_for('marcar_email_manual', email=cliente.email) }}" method="post"
                              onsubmit="return confirm('Tem certeza que deseja marcar o email de {{ cliente.nome }} como enviado?');">
                            <button type="submit" class="btn btn-sm btn-primary">
                                Marcar como enviado
                            </button>
                        </form>
                    </td>
                    <td class="d-flex gap-2">
                        <button type="button" class="btn btn-sm btn-success"
                                data-email="{{ cliente.email }}"
                                data-nome="{{ cliente.nome }}"
                                data-nacionalidade="{{ cliente.nacionalidade }}"
                                onclick="openEmailModalFromButton(this)">
                            Enviar Email
                        </button>
                        <form action="{{ url_for('remover_cliente', email=cliente.email) }}" method="post"
                              onsubmit="return confirm('Tem certeza que deseja remover {{ cliente.nome }}?');">
                            <button type="submit" class="btn btn-sm btn-danger">Remover Cliente</button>
                        </form>
                    </td>
                </tr>
            {% else %}
                <tr>
                    <td colspan="{% if session.get('is_admin') %}14{% else %}13{% endif %}" class="text-center">
                        Nenhum cliente cadastrado
                    </td>
                </tr>
            {% endfor %}

            <!-- Email Edit Modal -->
            <div class="modal fade" id="emailModal" tabindex="-1" aria-labelledby="emailModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="emailModalLabel">Editar Email</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="emailForm">
                                <input type="hidden" id="clienteEmail" name="email">
                                <div class="mb-3">
                                    <label for="emailSubject" class="form-label">Assunto:</label>
                                    <input type="text" class="form-control" id="emailSubject" name="subject" required>
                                </div>
                                <div class="mb-3">
                                    <label for="emailContent" class="form-label">Conteúdo do Email:</label>
                                    <div class="mb-2">
                                        <button type="button" class="btn btn-outline-primary btn-sm"
                                                onclick="attachImage()">
                                            <i class="fas fa-image"></i> Anexar Imagem
                                        </button>
                                        <input type="file" id="imageInput" accept="image/*" style="display: none;"
                                               onchange="handleImageUpload(this)">
                                        <small class="text-muted d-block mt-1">
                                            <i class="fas fa-info-circle"></i> As imagens serão enviadas como anexos
                                            separados no
                                            email.
                                        </small>
                                    </div>
                                    <div id="attachmentList" class="mb-2" style="display: none;">
                                        <div class="card">
                                            <div class="card-header py-2">
                                                <h6 class="mb-0"><i class="fas fa-paperclip"></i> Anexos</h6>
                                            </div>
                                            <div class="card-body py-2" id="attachmentItems">
                                                <!-- Attachment items will be added here -->
                                            </div>
                                        </div>
                                    </div>
                                    <div id="quillEditor" style="height: 300px;"></div>
                                    <input type="hidden" id="emailContent" name="content">
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="button" class="btn btn-primary" onclick="sendCustomEmail()">Enviar Email
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

            <div id="loading" class="text-center my-3" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Carregando...</span>
                </div>
                <p>Atualizando dados...</p>
            </div>

            <script>

                function atualizarTabela() {
                    document.getElementById('loading').style.display = 'block';

                    fetch('/atualizar-tabela')
                        .then(response => {
                            if (!response.ok) throw new Error('Erro na rede');
                            return response.text();
                        })
                        .then(html => {
                            document.querySelector('tbody').innerHTML = html;
                            configurarEventosForms();

                            // Re-apply current filter if one is active
                            var selectedMonth = document.getElementById('monthFilter').value;
                            if (selectedMonth && selectedMonth !== '') {
                                filterByMonth();
                            }
                        })
                        .catch(error => {
                            console.error('Erro:', error);
                        })
                        .finally(() => {
                            document.getElementById('loading').style.display = 'none';
                        });
                }


                function configurarEventosForms() {

                    document.querySelectorAll('.form-enviar').forEach(form => {
                        form.addEventListener('submit', function (e) {
                            e.preventDefault();
                            enviarFormulario(this);
                        });
                    });


                    document.querySelectorAll('.form-remover').forEach(form => {
                        form.addEventListener('submit', function (e) {
                            if (!confirm('Tem certeza que deseja remover este cliente?')) {
                                e.preventDefault();
                                return;
                            }
                            enviarFormulario(this);
                        });
                    });
                }


                function enviarFormulario(form) {
                    fetch(form.action, {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                        .then(response => {
                            if (response.redirected) {
                                window.location.href = response.url;
                            } else {
                                atualizarTabela();
                            }
                        })
                        .catch(error => console.error('Erro:', error));
                }


                setInterval(atualizarTabela, 15000);

                document.addEventListener('DOMContentLoaded', function () {
                    configurarEventosForms();
                    atualizarTabela();
                    // Add confirmation for 'Enviar email para todos' form
                    var enviarTodosForm = document.getElementById('enviar-todos-form');
                    if (enviarTodosForm) {
                        enviarTodosForm.addEventListener('submit', function (e) {
                            if (!confirm('Deseja enviar email para TODOS os clientes?')) {
                                e.preventDefault();
                            }
                        });
                    }
                    // IVA calculation logic
                    var baseInput = document.getElementById('valor_fatura_base');
                    var ivaInput = document.getElementById('iva');
                    var ivaSpan = document.getElementById('valor_com_iva');
                    var finalInput = document.getElementById('valor_fatura');
                    var descontoInput = document.getElementById('desconto');
                    var originalFinalValue = 0; // Store the original final value

                    function updateIVA() {
                        var base = parseFloat(baseInput.value) || 0;
                        var iva = (parseFloat(ivaInput.value) || 22) / 100; // Now expects percentage
                        var comIva = (base * (1 + iva)).toFixed(2);
                        ivaSpan.textContent = comIva;

                        var desconto = parseFloat(descontoInput.value) || 0;

                        // Only update the final value if it's completely empty (first time) or if base/IVA changed
                        var currentFinalValue = parseFloat(finalInput.value);
                        if (isNaN(currentFinalValue) || baseInput.value !== baseInput.dataset.lastBase || ivaInput.value !== ivaInput.dataset.lastIva) {
                            originalFinalValue = parseFloat(comIva);
                            finalInput.value = comIva;
                            baseInput.dataset.lastBase = baseInput.value;
                            ivaInput.dataset.lastIva = ivaInput.value;
                        }

                        // Apply discount to the original final value
                        var valorFinal = originalFinalValue;
                        if (desconto > 0 && desconto < 100) {
                            valorFinal = (originalFinalValue * (1 - desconto / 100)).toFixed(2);
                        }
                        finalInput.value = valorFinal;
                    }

                    baseInput.addEventListener('input', updateIVA);
                    ivaInput.addEventListener('input', updateIVA);
                    descontoInput.addEventListener('input', updateIVA);
                    finalInput.addEventListener('input', function () {
                        // When user manually changes the final value, update the original value
                        var newValue = parseFloat(this.value);
                        if (!isNaN(newValue)) {
                            originalFinalValue = newValue;
                        }
                    });
                    updateIVA();
                    // Initialize Quill
                    quill = new Quill('#quillEditor', {
                        theme: 'snow'
                    });
                });

                function openEmailModal(email, nome, nacionalidade) {
                    console.log('openEmailModal called with:', email, nome, nacionalidade);

                    // Ensure quill is initialized
                    if (typeof quill === 'undefined') {
                        console.error('Quill editor not initialized');
                        return;
                    }

                    // Clear previous attachments
                    emailAttachments = [];
                    document.getElementById('attachmentItems').innerHTML = '';
                    document.getElementById('attachmentList').style.display = 'none';

                    document.getElementById('clienteEmail').value = email;
                    // Set default subject based on nationality
                    var defaultSubject = {
                        'inglês': "Thank you for your diving experience!",
                        'francês': "Merci d'avoir plongé avec nous",
                        'alemão': "Danke für Ihr Taucherlebnis",
                    }[nacionalidade] || "Obrigado pela sua experiência de mergulho!";
                    document.getElementById('emailSubject').value = defaultSubject;

                    // Load default email content based on nationality
                    fetch(`/get-email-template/${email}`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (quill && quill.root) {
                                quill.root.innerHTML = data.content;
                            }
                        })
                        .catch(error => {
                            console.error('Error loading template:', error);
                            if (quill && quill.root) {
                                quill.root.innerHTML = `Olá ${nome},<br><br>Obrigado pela sua experiência de mergulho!<br><br>Atenciosamente,<br>Atlantic Diving Center`;
                            }
                        });

                    try {
                        var modalElement = document.getElementById('emailModal');
                        if (!modalElement) {
                            console.error('Email modal element not found');
                            return;
                        }

                        var modal = new bootstrap.Modal(modalElement);
                        console.log('Modal created, showing...');
                        modal.show();
                        console.log('Modal show() called');
                    } catch (error) {
                        console.error('Error creating/showing modal:', error);
                    }
                }

                function sendCustomEmail() {
                    document.getElementById('emailContent').value = quill.root.innerHTML;
                    var formData = new FormData(document.getElementById('emailForm'));

                    // Add attachments to form data
                    emailAttachments.forEach((attachment, index) => {
                        formData.append(`attachment_${index}`, attachment.file);
                    });

                    fetch('/enviar-email-personalizado', {
                        method: 'POST',
                        body: formData
                    })
                        .then(response => {
                            if (response.ok) {
                                alert('Email enviado com sucesso!');
                                var modal = bootstrap.Modal.getInstance(document.getElementById('emailModal'));
                                modal.hide();
                                atualizarTabela();
                            } else if (response.status === 400) {
                                // Check if it's because email was already sent
                                response.text().then(text => {
                                    if (text.includes('Email já enviado')) {
                                        alert('Este email já foi enviado anteriormente.');
                                    } else {
                                        alert('Erro ao enviar email: ' + text);
                                    }
                                });
                            } else {
                                response.text().then(text => {
                                    alert('Erro ao enviar email: ' + text);
                                });
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('Erro ao enviar email: ' + error.message);
                        });
                }

                function openEmailModalFromButton(btn) {
                    openEmailModal(
                        btn.getAttribute('data-email'),
                        btn.getAttribute('data-nome'),
                        btn.getAttribute('data-nacionalidade')
                    );
                }

                // Global variable to store attachments
                let emailAttachments = [];

                function attachImage() {
                    const imageInput = document.getElementById('imageInput');
                    if (imageInput) {
                        imageInput.click();
                    } else {
                        console.error('Image input element not found');
                    }
                }

                function handleImageUpload(input) {
                    const file = input.files[0];
                    if (file) {
                        // Validate file type
                        if (!file.type.startsWith('image/')) {
                            alert('Por favor, selecione apenas arquivos de imagem.');
                            input.value = '';
                            return;
                        }

                        // Validate file size (max 5MB)
                        if (file.size > 5 * 1024 * 1024) {
                            alert('A imagem deve ter menos de 5MB.');
                            input.value = '';
                            return;
                        }

                        // Add file to attachments list
                        addAttachmentToList(file);
                    }
                    // Reset input
                    input.value = '';
                }

                function addAttachmentToList(file) {
                    const attachmentId = 'attachment_' + Date.now();
                    const fileSize = (file.size / 1024).toFixed(1) + ' KB';

                    // Add to attachments array
                    emailAttachments.push({
                        id: attachmentId,
                        file: file,
                        name: file.name,
                        size: fileSize,
                        type: file.type
                    });

                    // Create attachment item HTML
                    const attachmentItem = document.createElement('div');
                    attachmentItem.className = 'attachment-item d-flex align-items-center justify-content-between p-2 border-bottom';
                    attachmentItem.id = attachmentId;
                    attachmentItem.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="fas fa-image text-primary me-2"></i>
                <div>
                    <div class="fw-bold">${file.name}</div>
                    <small class="text-muted">${fileSize}</small>
                </div>
            </div>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeAttachment('${attachmentId}')">
                <i class="fas fa-times"></i>
            </button>
        `;

                    // Add to attachment list
                    document.getElementById('attachmentItems').appendChild(attachmentItem);
                    document.getElementById('attachmentList').style.display = 'block';
                }

                function removeAttachment(attachmentId) {
                    // Remove from attachments array
                    emailAttachments = emailAttachments.filter(att => att.id !== attachmentId);

                    // Remove from DOM
                    const attachmentItem = document.getElementById(attachmentId);
                    if (attachmentItem) {
                        attachmentItem.remove();
                    }

                    // Hide attachment list if empty
                    if (emailAttachments.length === 0) {
                        document.getElementById('attachmentList').style.display = 'none';
                    }
                }

                // Month filter functions
                function toggleFilterPanel() {
                    var filterPanel = document.getElementById('filterPanel');
                    if (filterPanel.style.display === 'none') {
                        filterPanel.style.display = 'block';
                    } else {
                        filterPanel.style.display = 'none';
                    }
                }

                function filterByMonth() {
                    var selectedMonth = document.getElementById('monthFilter').value;
                    var tableRows = document.querySelectorAll('tbody tr');

                    tableRows.forEach(function (row) {
                        var dateCell = row.querySelector('td:nth-child(5)'); // Date column
                        if (dateCell) {
                            var dateText = dateCell.textContent.trim();
                            // Parse date in dd/mm/yyyy format
                            var dateParts = dateText.split('/');
                            if (dateParts.length === 3) {
                                var day = parseInt(dateParts[0]);
                                var month = parseInt(dateParts[1]);
                                var year = parseInt(dateParts[2]);
                                var rowMonth = month.toString().padStart(2, '0');

                                if (selectedMonth === '' || rowMonth === selectedMonth) {
                                    row.style.display = '';
                                } else {
                                    row.style.display = 'none';
                                }
                            }
                        }
                    });

                    // Update row count
                    updateRowCount();
                }

                function clearFilter() {
                    document.getElementById('monthFilter').value = '';
                    var tableRows = document.querySelectorAll('tbody tr');
                    tableRows.forEach(function (row) {
                        row.style.display = '';
                    });
                    updateRowCount();
                }

                function updateRowCount() {
                    var visibleRows = document.querySelectorAll('tbody tr:not([style*="display: none"])').length;
                    var totalRows = document.querySelectorAll('tbody tr').length;

                    // You can add a counter display here if needed
                    console.log('Visible rows: ' + visibleRows + ' of ' + totalRows);
                }


                // Auto-filter when month is selected
                document.addEventListener('DOMContentLoaded', function () {
                    var monthFilter = document.getElementById('monthFilter');
                    if (monthFilter) {
                        monthFilter.addEventListener('change', filterByMonth);
                    }
                });


                document.addEventListener('DOMContentLoaded', function () {
                    console.log("Script carregado!");

                    document.body.addEventListener('click', async function (event) {
                        if (event.target.classList.contains('guardar-btn')) {
                            console.log("Botão clicado!");

                            const td = event.target.closest('td');
                            const input = td.querySelector('.gastos-input');
                            const email = input.dataset.email;
                            const gastos = parseFloat(input.value);

                            try {
                                const response = await fetch('/update-gastos', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({email, gastos})
                                });

                                const result = await response.json();
                                console.log("Resposta do servidor:", result);

                                if (result.success) {
                                    alert('✅ Gastos atualizados com sucesso!');
                                } else {
                                    alert('❌ Erro ao atualizar: ' + result.error);
                                }
                            } catch (error) {
                                alert('❌ Erro na requisição: ' + error.message);
                            }
                        }
                    });
                });


                document.addEventListener("DOMContentLoaded", function () {
                    const valorFaturaInput = document.getElementById("valor_fatura");
                    const gastosInput = document.getElementById("gastos");
                    const receitaInput = document.getElementById("receita");

                    function calcularReceita() {
                        const valorFatura = parseFloat(valorFaturaInput?.value) || 0;
                        const gastos = parseFloat(gastosInput?.value) || 0;
                        const receita = valorFatura - gastos;
                        receitaInput.value = receita.toFixed(2);
                    }

                    valorFaturaInput?.addEventListener("input", calcularReceita);
                    gastosInput?.addEventListener("input", calcularReceita);

                    calcularReceita(); // inicializa valor
                });
            </script>


            </tbody>
        </table>
    </div>
</div>
</body>
</html>