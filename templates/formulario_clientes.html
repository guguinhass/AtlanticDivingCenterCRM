<!doctype html>
<html>
<head>
    <title>CRM Atlantic Diving Center</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Add Quill CSS in <head> -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

    <style>
        .text-success {
            color: #28a745 !important;
        }

        .text-danger {
            color: #dc3545 !important;
        }

        .table-update {
            transition: background-color 1.5s ease;
        }

        .highlight {
            background-color: rgba(40, 167, 69, 0.2);
        }

        .iva-fade {
            opacity: 0;
            width: 0;
            transition: opacity 0.5s, width 0.5s;
            overflow: hidden;
            display: flex;
            align-items: center;
        }
        .iva-fade.show {
            opacity: 1 !important;
            width: 320px !important; /* Adjust as needed */
            margin-left: 0.5rem;
        }
    </style>
</head>
<body class="bg-light">

<div class="container mt-5">
    <div class="d-flex justify-content-start gap-3 mb-4">
        <form id="enviar-todos-form" action="{{ url_for('enviar_manual_todos') }}" method="POST" class="m-0">
            <button type="submit" class="btn btn-success">Enviar email para todos</button>
        </form>

        {% if session.get('is_admin') %}
            <a href="{{ url_for('exportar_emails') }}" class="btn btn-success">Exportar para Excel</a>
            <a href="{{ url_for('manage_users') }}" class="btn btn-success">Gerir Utilizadores</a>
        {% endif %}
    </div>

    <h2 class="text-center mb-4">Cadastro de Cliente</h2>

    {% if mensagem %}
        <div class="alert alert-danger text-center">{{ mensagem }}</div>
    {% endif %}

    <form method="post" class="p-4 bg-white rounded shadow-sm">
        <div class="mb-3">
            <label class="form-label">Nome:</label>
            <input type="text" name="nome" class="form-control" required>
        </div>

        <div class="mb-3">
            <label class="form-label">Nº de Mergulhos:</label>
            <input type="number" name="num_mergulho" class="form-control" required min="1">
        </div>

        <div class="mb-3">
            <label class="form-label">Email:</label>
            <input type="email" name="email" class="form-control" required>
        </div>

        <div class="mb-3">
            <label class="form-label">Data do Mergulho:</label>
            <input type="date" name="data_mergulho" class="form-control" required>
        </div>

        <div class="mb-3">
            <label class="form-label">Valor:</label>
            <div class="input-group mb-2">
                <input type="number" step="0.01" name="valor_fatura_base" id="valor_fatura_base" class="form-control" required min="0" placeholder="Valor sem IVA">
                <span class="input-group-text">€</span>
            </div>
            <div class="form-text">Com IVA: <span id="valor_com_iva" class="fw-bold">0.00</span> €</div>
        </div>

        <div class="mb-3">
            <label class="form-label">IVA:</label>
            <input type="number" name="iva" id="iva" class="form-control" min="0" max="1" step="0.01" value="0.22" required>
            <div class="form-text">IVA a ser aplicado para este cliente (ex: 0.22 para 22%)</div>
        </div>

        <div class="mb-3">
            <label class="form-label">Valor Final (pode editar):</label>
            <div class="input-group">
                <input type="number" step="0.01" name="valor_fatura" id="valor_fatura" class="form-control" required min="0" placeholder="Valor final a ser salvo">
                <span class="input-group-text">€</span>
            </div>
            <div class="form-text">Este valor será salvo na tabela. O desconto será aplicado sobre este valor.</div>
        </div>

        <div class="mb-3">
            <label class="form-label">Desconto (%):</label>
            <input type="number" name="desconto" id="desconto" class="form-control" min="0" max="100" step="0.01" placeholder="0">
            <div class="form-text">Opcional. Percentual de desconto a ser aplicado ao valor final acima.</div>
        </div>

        <div class="mb-3">
            <label class="form-label">Nacionalidade:</label>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="nacionalidade" id="português" value="português" checked>
                <label class="form-check-label" for="português">Português</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="nacionalidade" id="inglês" value="inglês">
                <label class="form-check-label" for="inglês">Inglês</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="nacionalidade" id="francês" value="francês">
                <label class="form-check-label" for="francês">Francês</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="nacionalidade" id="alemão" value="alemão">
                <label class="form-check-label" for="alemão">Alemão</label>
            </div>
        </div>

        <div class="text-center">
            <input type="submit" value="Cadastrar" class="btn btn-primary px-4">
        </div>
    </form>

    <h2 class="text-center mt-5 mb-4">Clientes Cadastrados</h2>
    <button type="button" class="btn btn-primary" onclick="toggleFilterPanel()">Filtrar por Mês</button>
    <p></p>
    <!-- Month Filter -->

    <div id="filterPanel" class="row mb-3" style="display: none;">
        <div class="col-md-6 offset-md-3">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex align-items-center gap-3">
                        <label for="monthFilter" class="form-label mb-0">Filtrar por mês:</label>
                        <select id="monthFilter" class="form-select" style="width: auto;">
                            <option value="">Todos os meses</option>
                            <option value="01">Janeiro</option>
                            <option value="02">Fevereiro</option>
                            <option value="03">Março</option>
                            <option value="04">Abril</option>
                            <option value="05">Maio</option>
                            <option value="06">Junho</option>
                            <option value="07">Julho</option>
                            <option value="08">Agosto</option>
                            <option value="09">Setembro</option>
                            <option value="10">Outubro</option>
                            <option value="11">Novembro</option>
                            <option value="12">Dezembro</option>
                        </select>
                        <button type="button" class="btn btn-primary" onclick="filterByMonth()">Filtrar</button>
                        <button type="button" class="btn btn-secondary" onclick="clearFilter()">Limpar Filtro</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-bordered table-striped table-hover">
            <thead class="table-dark">
            <tr>
                <th>Adicionado por</th>
                <th>Nome</th>
                <th>Email</th>
                <th>Nº Mergulhos</th>
                <th>Data Mergulho</th>
                <th>Valor   (€)</th>
                <th>IVA</th>
                <th>Desconto (%)</th>
                <th>Nacionalidade</th>
                <th>1º Email</th>
                <th>2º Email</th>
                <th>Email Manual</th>
                <th>Ações</th>
            </tr>
            </thead>
            <tbody>
            {% for cliente in clientes %}
                <tr>
                    <td>{{ cliente.adicionado_por if cliente.adicionado_por else 'Desconhecido' }}</td>
                    <td>{{ cliente.nome }}</td>
                    <td>{{ cliente.email }}</td>
                    <td>{{ cliente.num_mergulho }}</td>
                    <td>{{ cliente.formatted_date }}</td>
                    <td>{{ "%.2f"|format(cliente.valor_fatura) }} €
                        {% if cliente.desconto and cliente.desconto > 0 %}{% endif %}
                    </td>
                    <td>{{ "%.0f"|format(cliente.iva * 100)}}% </td>
                    <td>{% if cliente.desconto %}{{ cliente.desconto }}%{% else %}0.0{% endif %}</td>
                    <td>{{ cliente.nacionalidade.capitalize() }}</td>
                    <td>{{ 'Sim' if cliente.primeiro_email_enviado else 'Não' }}</td>
                    <td>{{ 'Sim' if cliente.segundo_email_enviado else 'Não' }}</td>
                    <td>{{ 'Sim' if cliente.email_manual_enviado else 'Não' }}</td>
                    <td class="d-flex gap-2">
                        <button type="button" class="btn btn-sm btn-success"

                                data-email="{{ cliente.email }}"
                                data-nome="{{ cliente.nome }}"
                                data-nacionalidade="{{ cliente.nacionalidade }}"
                                onclick="openEmailModalFromButton(this)">
                            Enviar Email
                        </button>
                        <form action="{{ url_for('remover_cliente', email=cliente.email) }}" method="post"
                              onsubmit="return confirm('Tem certeza que deseja remover {{ cliente.nome }}?');">
                            <button type="submit" class="btn btn-sm btn-danger">Remover Cliente</button>
                        </form>
                    </td>
                </tr>
            {% else %}
                <tr>
                    <td colspan="12" class="text-center">Nenhum cliente cadastrado</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Email Edit Modal -->
<div class="modal fade" id="emailModal" tabindex="-1" aria-labelledby="emailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="emailModalLabel">Editar Email</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="emailForm">
                    <input type="hidden" id="clienteEmail" name="email">
                    <div class="mb-3">
                        <label for="emailSubject" class="form-label">Assunto:</label>
                        <input type="text" class="form-control" id="emailSubject" name="subject" required>
                    </div>
                    <div class="mb-3">
                        <label for="emailContent" class="form-label">Conteúdo do Email:</label>
                        <div id="quillEditor" style="height: 300px;"></div>
                        <input type="hidden" id="emailContent" name="content">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="sendCustomEmail()">Enviar Email</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<div id="loading" class="text-center my-3" style="display: none;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Carregando...</span>
    </div>
    <p>Atualizando dados...</p>
</div>

<script>

    function atualizarTabela() {
        document.getElementById('loading').style.display = 'block';

        fetch('/atualizar-tabela')
            .then(response => {
                if (!response.ok) throw new Error('Erro na rede');
                return response.text();
            })
            .then(html => {
                document.querySelector('tbody').innerHTML = html;
                configurarEventosForms();

                // Re-apply current filter if one is active
                var selectedMonth = document.getElementById('monthFilter').value;
                if (selectedMonth && selectedMonth !== '') {
                    filterByMonth();
                }
            })
            .catch(error => {
                console.error('Erro:', error);
            })
            .finally(() => {
                document.getElementById('loading').style.display = 'none';
            });
    }


    function configurarEventosForms() {

        document.querySelectorAll('.form-enviar').forEach(form => {
            form.addEventListener('submit', function (e) {
                e.preventDefault();
                enviarFormulario(this);
            });
        });


        document.querySelectorAll('.form-remover').forEach(form => {
            form.addEventListener('submit', function (e) {
                if (!confirm('Tem certeza que deseja remover este cliente?')) {
                    e.preventDefault();
                    return;
                }
                enviarFormulario(this);
            });
        });
    }


    function enviarFormulario(form) {
        fetch(form.action, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
            .then(response => {
                if (response.redirected) {
                    window.location.href = response.url;
                } else {
                    atualizarTabela();
                }
            })
            .catch(error => console.error('Erro:', error));
    }


    setInterval(atualizarTabela, 30000); // Reduced from 10 seconds to 30 seconds

    document.addEventListener('DOMContentLoaded', function () {
        configurarEventosForms();
        atualizarTabela();
        // Add confirmation for 'Enviar email para todos' form
        var enviarTodosForm = document.getElementById('enviar-todos-form');
        if (enviarTodosForm) {
            enviarTodosForm.addEventListener('submit', function (e) {
                if (!confirm('Deseja enviar email para TODOS os clientes?')) {
                    e.preventDefault();
                }
            });
        }
        // IVA calculation logic
        var baseInput = document.getElementById('valor_fatura_base');
        var ivaInput = document.getElementById('iva');
        var ivaSpan = document.getElementById('valor_com_iva');
        var finalInput = document.getElementById('valor_fatura');
        var descontoInput = document.getElementById('desconto');
        var originalFinalValue = 0; // Store the original final value

        function updateIVA() {
            var base = parseFloat(baseInput.value) || 0;
            var iva = parseFloat(ivaInput.value) || 0.22;
            var comIva = (base * (1 + iva)).toFixed(2);
            ivaSpan.textContent = comIva;

            // Get the current final value (either from user input or calculated)
            var currentFinalValue = parseFloat(finalInput.value) || parseFloat(comIva);
            var desconto = parseFloat(descontoInput.value) || 0;

            // If this is the first time or the base/IVA changed, update the original value
            if (originalFinalValue === 0 || baseInput.value !== baseInput.dataset.lastBase || ivaInput.value !== ivaInput.dataset.lastIva) {
                originalFinalValue = currentFinalValue;
                baseInput.dataset.lastBase = baseInput.value;
                ivaInput.dataset.lastIva = ivaInput.value;
            }

            // Apply discount to the original final value
            var valorFinal = originalFinalValue;
            if (desconto > 0 && desconto < 100) {
                valorFinal = (originalFinalValue * (1 - desconto / 100)).toFixed(2);
            }
            finalInput.value = valorFinal;
        }

        baseInput.addEventListener('input', updateIVA);
        ivaInput.addEventListener('input', updateIVA);
        descontoInput.addEventListener('input', updateIVA);
        finalInput.addEventListener('input', function() {
            // When user manually changes the final value, update the original value
            originalFinalValue = parseFloat(finalInput.value) || 0;
            updateIVA();
        });
        updateIVA();
        // Initialize Quill
        quill = new Quill('#quillEditor', {
            theme: 'snow'
        });
    });

    function openEmailModal(email, nome, nacionalidade) {
        console.log('openEmailModal called with:', email, nome, nacionalidade);
        document.getElementById('clienteEmail').value = email;
        // Set default subject based on nationality
        var defaultSubject = {
            'inglês': "Thank you for your diving experience!",
            'francês': "Merci d'avoir plongé avec nous",
            'alemão': "Danke für Ihr Taucherlebnis",
        }[nacionalidade] || "Obrigado pela sua experiência de mergulho!";
        document.getElementById('emailSubject').value = defaultSubject;
        // Load default email content based on nationality
        fetch(`/get-email-template/${email}`)
            .then(response => response.json())
            .then(data => {
                quill.root.innerHTML = data.content;
            })
            .catch(error => {
                console.error('Error loading template:', error);
                quill.root.innerHTML = `Olá ${nome},<br><br>Obrigado pela sua experiência de mergulho!<br><br>Atenciosamente,<br>Atlantic Diving Center`;
            });
        try {
            var modal = new bootstrap.Modal(document.getElementById('emailModal'));
            console.log('Modal created, showing...');
            modal.show();
            console.log('Modal show() called');
        } catch (error) {
            console.error('Error creating/showing modal:', error);
        }
    }

    function sendCustomEmail() {
        document.getElementById('emailContent').value = quill.root.innerHTML;
        var formData = new FormData(document.getElementById('emailForm'));
        fetch('/enviar-email-personalizado', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.ok) {
                alert('Email enviado com sucesso!');
                var modal = bootstrap.Modal.getInstance(document.getElementById('emailModal'));
                modal.hide();
                atualizarTabela();
            } else {
                alert('Erro ao enviar email');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Erro ao enviar email');
        });
    }

    function openEmailModalFromButton(btn) {
        openEmailModal(
            btn.getAttribute('data-email'),
            btn.getAttribute('data-nome'),
            btn.getAttribute('data-nacionalidade')
        );
    }

    // Month filter functions
    function toggleFilterPanel() {
        var filterPanel = document.getElementById('filterPanel');
        if (filterPanel.style.display === 'none') {
            filterPanel.style.display = 'block';
        } else {
            filterPanel.style.display = 'none';
        }
    }

    function filterByMonth() {
        var selectedMonth = document.getElementById('monthFilter').value;
        var tableRows = document.querySelectorAll('tbody tr');

        tableRows.forEach(function(row) {
            var dateCell = row.querySelector('td:nth-child(5)'); // Date column
            if (dateCell) {
                var dateText = dateCell.textContent.trim();
                // Parse date in dd/mm/yyyy format
                var dateParts = dateText.split('/');
                if (dateParts.length === 3) {
                    var day = parseInt(dateParts[0]);
                    var month = parseInt(dateParts[1]);
                    var year = parseInt(dateParts[2]);
                    var rowMonth = month.toString().padStart(2, '0');

                    if (selectedMonth === '' || rowMonth === selectedMonth) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                }
            }
        });

        // Update row count
        updateRowCount();
    }

    function clearFilter() {
        document.getElementById('monthFilter').value = '';
        var tableRows = document.querySelectorAll('tbody tr');
        tableRows.forEach(function(row) {
            row.style.display = '';
        });
        updateRowCount();
    }

    function updateRowCount() {
        var visibleRows = document.querySelectorAll('tbody tr:not([style*="display: none"])').length;
        var totalRows = document.querySelectorAll('tbody tr').length;

        // You can add a counter display here if needed
        console.log('Visible rows: ' + visibleRows + ' of ' + totalRows);
    }

    // Auto-filter when month is selected
    document.addEventListener('DOMContentLoaded', function() {
        var monthFilter = document.getElementById('monthFilter');
        if (monthFilter) {
            monthFilter.addEventListener('change', filterByMonth);
        }
    });
</script>
</body>
</html>