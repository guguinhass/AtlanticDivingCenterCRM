{% for cliente in clientes %}
<tr>
    <td>{{ cliente.adicionado_por if cliente.adicionado_por else 'Desconhecido' }}</td>
    <td>{{ cliente.nome }}</td>
    <td>{{ cliente.email }}</td>
    <td>{{ cliente.num_mergulho }}</td>
    <td>{{ cliente.formatted_date }}</td>
    <td>{{ "%.2f"|format(cliente.valor_fatura) }} €
        {% if cliente.desconto and cliente.desconto > 0 %}{% endif %}
    </td>
    <td>{{ "%.0f"|format(cliente.iva * 100) }}%</td>
    <td>{% if cliente.desconto %}{{ cliente.desconto }}%{% else %}0.0{% endif %}</td>
    {% if session.get('is_admin') %}
    <td>
        <input type="number" class="form-control form-control-sm gastos-input" value="{{ '%.2f'|format(cliente.gastos) if cliente.gastos else '0.00' }}" data-email="{{ cliente.email }}" style="width: 90px; display: inline-block;" min="0" step="0.01">
        €
    </td>
    {% endif %}
    <td>{{ cliente.nacionalidade.capitalize() }}</td>
    <td>{{ 'Sim' if cliente.primeiro_email_enviado else 'Não' }}</td>
    <td>{{ 'Sim' if cliente.segundo_email_enviado else 'Não' }}</td>
    <td>{{ 'Sim' if cliente.email_manual_enviado else 'Não' }}</td>
    <td class="d-flex gap-2">
        <button type="button" class="btn btn-sm btn-success"
                data-email="{{ cliente.email }}"
                data-nome="{{ cliente.nome }}"
                data-nacionalidade="{{ cliente.nacionalidade }}"
                onclick="openEmailModalFromButton(this)">
            Enviar Email
        </button>
        <form action="{{ url_for('remover_cliente', email=cliente.email) }}" method="post"
              onsubmit="return confirm('Tem certeza que deseja remover {{ cliente.nome }}?');">
            <button type="submit" class="btn btn-sm btn-danger">Remover Cliente</button>
        </form>
    </td>
</tr>
{% else %}
<tr>
    <td colspan="{% if session.get('is_admin') %}14{% else %}13{% endif %}" class="text-center">Nenhum cliente cadastrado</td>
</tr>
{% endfor %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('.gastos-input').forEach(function(input) {
        input.addEventListener('change', function() {
            const email = this.getAttribute('data-email');
            const gastos = parseFloat(this.value) || 0;
            fetch('/update-gastos', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ email, gastos })
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    alert('Erro ao atualizar gastos: ' + (data.error || 'Erro desconhecido'));
                }
            })
            .catch(() => alert('Erro ao atualizar gastos.'));
        });
    });
});
</script>